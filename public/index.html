<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÊöñÊ∏ØÈáé HA TALK</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03QD2SY1QM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03QD2SY1QM');
    </script>

    <style>
        :root {
            --bg-color: #6a6461; --header-color: #8c8485;
            --my-msg: #4e6579; --partner-msg: #8c8485;
            --accent-color: #a08bab; --text-white: #ffffff;
            --sidebar-bg: #4a4542;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; background: var(--bg-color); 
            height: 100vh; height: 100dvh; 
            display: flex; color: var(--text-white); 
            overflow: hidden; overscroll-behavior: none; 
        }
        
        #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: 0.3s ease; z-index: 2000; position: absolute; left: -260px; height: 100%; }
        #sidebar.open { left: 0; }
        .menu-item { padding: 15px 20px; color: #ddd; text-decoration: none; display: block; cursor: pointer; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500; }
        #sidebar.open ~ #overlay { display: block; }

        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }
        header { background: var(--header-color); padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; flex-shrink: 0; }
        
        #status-bar { display: none; background: #e6b800; color: #333; font-size: 12px; text-align: center; padding: 4px; font-weight: bold; }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        
        .suggestion-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 10px 0; }
        .topic-btn { background: var(--accent-color); color: white; border: none; padding: 10px 16px; border-radius: 15px; font-size: 14px; cursor: pointer; }

        #typing-status { font-size: 12px; color: #d1d1d1; padding: 5px 20px; height: 20px; font-style: italic; background: rgba(0,0,0,0.05); }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; }
        .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.partner { align-self: flex-start; }
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.me { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .msg.partner { background: var(--partner-msg); border-bottom-left-radius: 4px; }
        
        .system { align-self: center; font-size: 12px; color: #d1d1d1; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 12px; text-align: center; margin: 5px 0; }

        #input-area { background: var(--header-color); padding: 10px; display: flex; gap: 8px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        input { flex: 1; border: none; background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 25px; color: white; outline: none; font-size: 16px; }
        button#btn { background: var(--accent-color); border: none; color: white; font-weight: bold; padding: 0 20px; border-radius: 25px; cursor: pointer; min-width: 60px; }
        button#btn:disabled { opacity: 0.5; }
        #end-btn { background: rgba(220, 60, 60, 0.9); border: none; color: white; font-weight: bold; padding: 0 16px; margin-right: 8px; border-radius: 25px; cursor: pointer; display: none; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="menu-item" style="border-bottom:1px solid #666; font-weight:bold;">ÊöñÊ∏ØÈáé HA TALK</div>
        <div class="menu-item" onclick="closeSidebar()">üè† Âç≥ÊôÇÈÖçÂ∞çËÅäÂ§©</div>
        <a href="https://www.instagram.com/hatalk_canton" target="_blank" class="menu-item">üì∏ Instagram</a>
    </div>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div id="main-container">
        <header>
            <span onclick="toggleSidebar(event)" style="cursor:pointer; padding:5px 15px; font-size:20px;">‚ò∞</span>
            ÊöñÊ∏ØÈáé HA TALK
            <span style="width:50px;"></span>
        </header>

        <div id="status-bar">‚ö†Ô∏è Á∂≤Áµ°‰∏çÁ©©ÔºåÂòóË©¶ÈáçÈÄ£‰∏≠...</div>
        
        <div id="chat-box"></div>
        <div id="typing-status"></div>
        
        <div id="input-area">
            <button id="end-btn" onclick="endChat()">Èõ¢Èñã</button>
            <input id="msg" placeholder="ÊêµÂà∞‰∫∫ÂÖàÂèØ‰ª•ÂÇæË®à..." disabled autocomplete="off">
            <button id="btn" onclick="handleAction()" disabled>ÈñãÂßã</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // 1Ô∏è‚É£ [ÈóúÈçµ] Áî¢Áîü‰∏¶ËÆÄÂèñÂîØ‰∏ÄÁî®Êà∂ ID
        let myUserId = localStorage.getItem('ha_talk_uid');
        if (!myUserId) {
            myUserId = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            localStorage.setItem('ha_talk_uid', myUserId);
        }

        // 2Ô∏è‚É£ [ÈóúÈçµ] ÈÄ£Á∑öÊôÇÊîúÂ∏∂ ID
        const socket = io({
            auth: { token: myUserId },
            reconnection: true,
            reconnectionDelay: 1000,
            timeout: 10000, // ÂâçÁ´Ø‰πüË®≠Áü≠‰∏ÄÈªûÔºåÈÖçÂêàÂæåÁ´Ø
        });

        // Ëû¢ÂπïÂñöÈÜíÈéñ (Wake Lock)
        let wakeLock = null;
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }
        }

        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const statusBar = document.getElementById('status-bar');
        const typingStatus = document.getElementById('typing-status');
        const endBtn = document.getElementById('end-btn');

        let currentRoom = null;
        let typingTimeout = null;
        let waitTimer = null;

        function toggleSidebar(e) { e.stopPropagation(); document.getElementById('sidebar').classList.toggle('open'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

        // --- ‰∏ªÊåâÈàïÈÇèËºØ ---
        function handleAction() {
            if (mainBtn.dataset.action === 'reload') {
                window.location.reload();
                return;
            }
            if (!currentRoom) startSearch();
            else sendMsg();
        }

        function startSearch() {
            socket.emit('start_chat');
            mainBtn.innerText = 'ÊêµÁ∑ä‰∫∫';
            mainBtn.disabled = true;
            chatBox.innerHTML = '';
            endBtn.style.display = 'none';
            addSystemMsg('Á≠âÈô£ÂìàÔºåÂπ´‰Ω†ÊêµÁ∑ä‰∫∫...');
            requestWakeLock();
        }

        // --- ÁôºÈÄÅË®äÊÅØ (Âê´Â§±ÊïóËôïÁêÜ) ---
        function sendMsg() {
            const text = msgInput.value.trim();
            if (!text || !currentRoom) return;

            // ÈéñÂÆö UI
            msgInput.disabled = true;
            mainBtn.disabled = true;

            // Ë®≠ÂÆöÂâçÁ´ØË∂ÖÊôÇ (Èò≤Ê≠¢‰º∫ÊúçÂô®Ê≤íÂèçÊáâÂç°Ê≠ª)
            const fallbackTimer = setTimeout(() => {
                if(msgInput.disabled) {
                    msgInput.disabled = false;
                    mainBtn.disabled = false;
                    addSystemMsg('‚ö†Ô∏è Á∂≤Áµ°‰∏çÁ©©ÔºåÂÇ≥ÈÄÅË∂ÖÊôÇ');
                }
            }, 3000);

            // 3Ô∏è‚É£ [ÈóúÈçµ] ‰ΩøÁî® Callback Á¢∫Ë™çÁôºÈÄÅÊàêÂäü
            socket.emit('send_msg', { msg: text }, (response) => {
                clearTimeout(fallbackTimer);
                msgInput.disabled = false;
                mainBtn.disabled = false;
                msgInput.focus();

                if (response.status === 'ok') {
                    addMsg(text, 'me');
                    msgInput.value = '';
                    socket.emit('stop_typing');
                    removeTopicButtons();
                } else {
                    addSystemMsg('‚ùå ÂÇ≥ÈÄÅÂ§±Êïó: ' + (response.msg || 'Êú™Áü•ÈåØË™§'));
                }
            });
        }

        function endChat() {
            if (confirm('Áúü‰øÇË¶ÅÈõ¢ÈñãÔºü')) {
                socket.emit('end_chat');
                resetToIdle();
            }
        }

        // --- Socket ‰∫ã‰ª∂ ---

        socket.on('connect', () => {
            console.log('Connected');
            statusBar.style.display = 'none';
            if (!currentRoom) {
                mainBtn.innerText = 'ÈñãÂßã';
                mainBtn.disabled = false;
            }
        });

        socket.on('disconnect', () => {
            console.log('Disconnected');
            statusBar.style.display = 'block';
            msgInput.disabled = true;
            mainBtn.disabled = true;
        });

        // ÈÖçÂ∞çÊàêÂäü
        socket.on('matched', (data) => {
            currentRoom = data.roomId;
            chatBox.innerHTML = '';
            addSystemMsg('‚úÖ ÊêµÂà∞‰∫∫ÂñáÔºÅÈñãÂßãÂÇæË®àÂï¶');
            
            if (data.topics) createTopicButtons(data.topics);
            
            msgInput.disabled = false;
            mainBtn.innerText = 'ÂÇ≥ÈÄÅ';
            mainBtn.disabled = false;
            endBtn.style.display = 'block';
            requestWakeLock();
        });

        socket.on('receive_msg', (data) => {
            addMsg(data.msg, 'partner');
        });

        // 4Ô∏è‚É£ [ÈóúÈçµ] Êñ∑Á∑öÈáçÈÄ£ÊÅ¢Âæ©
        socket.on('connection_recovered', (data) => {
            console.log('Session restored');
            currentRoom = data.roomId;
            statusBar.style.display = 'none';
            
            msgInput.disabled = false;
            mainBtn.innerText = 'ÂÇ≥ÈÄÅ';
            mainBtn.disabled = false;
            endBtn.style.display = 'block';
            addSystemMsg('‚úÖ Á∂≤Áµ°Â∑≤ÊÅ¢Âæ©');
        });

        socket.on('partner_status', (data) => {
            // Â∞çÊñπÊñ∑Á∑öÊàñÈáçÈÄ£ÁöÑÊèêÁ§∫
            typingStatus.innerText = data.msg;
        });

        socket.on('partner_left', (data) => {
            addSystemMsg(data.msg);
            resetToIdle();
        });

        socket.on('chat_ended', (data) => {
            addSystemMsg(data.msg);
            resetToIdle();
        });

        // --- UI ËºîÂä© ---
        
        function resetToIdle() {
            currentRoom = null;
            msgInput.disabled = true;
            msgInput.value = '';
            mainBtn.innerText = 'ÈñãÂßã';
            mainBtn.disabled = false;
            endBtn.style.display = 'none';
            typingStatus.innerText = '';
            removeTopicButtons();
        }

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg-wrapper ${type}`;
            div.innerHTML = `<div class="msg ${type}">${text.replace(/</g, '&lt;')}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function createTopicButtons(topics) {
            const container = document.createElement('div');
            container.className = 'suggestion-container';
            topics.forEach(topic => {
                const btn = document.createElement('button');
                btn.className = 'topic-btn';
                btn.innerText = topic;
                btn.onclick = () => { msgInput.value = topic; sendMsg(); };
                container.appendChild(btn);
            });
            chatBox.appendChild(container);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        function removeTopicButtons() {
            document.querySelectorAll('.suggestion-container').forEach(e => e.remove());
        }

        // Ëº∏ÂÖ•Áõ£ËÅΩ
        msgInput.addEventListener('input', () => {
            if (currentRoom) {
                socket.emit('typing');
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => socket.emit('stop_typing'), 2000);
            }
        });
        msgInput.addEventListener("keypress", (e) => { 
            if (e.key === "Enter") sendMsg(); 
        });

        // È†ÅÈù¢ÂèØË¶ãÊÄßÁõ£ËÅΩ (ÊâãÊ©üÂàáÊèõ App Âõû‰æÜÊôÇÂº∑Âà∂ÈáçÈÄ£)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                requestWakeLock();
                if (!socket.connected) {
                    console.log('Waking up socket...');
                    socket.connect();
                }
            }
        });
    </script>
</body>
</html>