<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æš–æ¸¯é‡ HA TALK</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03QD2SY1QM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // åŠ å…¥ debug_mode å”åŠ©å³æ™‚æª¢æ¸¬è³‡æ–™æµ
      gtag('config', 'G-03QD2SY1QM', { 'debug_mode': true });
    </script>

    <style>
        :root {
            --bg-color: #6a6461; --header-color: #8c8485;
            --my-msg: #4e6579; --partner-msg: #8c8485;
            --accent-color: #a08bab; --text-white: #ffffff;
            --sidebar-bg: #4a4542;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg-color); height: 100vh; display: flex; color: var(--text-white); overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: 0.3s ease; z-index: 2000; position: relative; }
        .sidebar-header { padding: 25px 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-item { padding: 15px 20px; color: #ddd; text-decoration: none; display: block; transition: 0.2s; }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .menu-item.active { background: var(--accent-color); color: white; }

        /* Main Container */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; transition: 0.3s; width: 100%; }
        header { background: var(--header-color); padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        #typing-status { font-size: 12px; color: #d1d1d1; padding: 5px 20px; height: 18px; font-style: italic; }

        /* Messages */
        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; position: relative; }
        .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.partner { align-self: flex-start; }
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.me { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .msg.partner { background: var(--partner-msg); border-bottom-left-radius: 4px; }
        .read-status { font-size: 10px; color: #ccc; margin-top: 2px; height: 12px; }
        .system { align-self: center; font-size: 12px; color: #d1d1d1; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 12px; }

        /* Input Area */
        #input-area { background: var(--header-color); padding: 12px; display: flex; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        input { flex: 1; border: none; background: rgba(255,255,255,0.15); padding: 12px 18px; border-radius: 25px; color: white; outline: none; font-size: 16px; }
        button#btn { background: var(--accent-color); border: none; color: white; font-weight: bold; padding: 0 20px; margin-left: 10px; border-radius: 25px; cursor: pointer; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: -260px; height: 100%; }
            #sidebar.open { left: 0; }
            #sidebar.open ~ #main-container { transform: translateX(260px); filter: brightness(0.6); pointer-events: none; }
        }

        #disclaimer-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; color: #333; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">æš–æ¸¯é‡ HA TALK</div>
        <div class="menu-item active" onclick="closeSidebar()">ğŸ  å³æ™‚é…å°èŠå¤©</div>
        <a href="https://threads.net/@your_account" target="_blank" class="menu-item" onclick="gtag('event', 'click_social', {platform:'threads'})">ğŸ§µ Threads ç¤¾ç¾¤</a>
        <a href="https://forms.gle/your_form" target="_blank" class="menu-item" onclick="gtag('event', 'click_social', {platform:'submission'})">ğŸ“¸ æŠ•ç¨¿å°è©±</a>
    </div>

    <div id="main-container" onclick="closeSidebar()">
        <div id="disclaimer-modal">
            <div class="modal-content">
                <h3 style="color:var(--accent-color)">ä½¿ç”¨é ˆçŸ¥èˆ‡å…è²¬è²æ˜</h3>
                <p style="text-align:left; font-size:14px; color:#666;">1. åš´ç¦é¨·æ“¾ã€è©é¨™æˆ–éæ³•è¡Œç‚ºã€‚<br>2. ç³»çµ±ä¸å„²å­˜å°è©±ã€‚<br>3. é»æ“ŠåŒæ„å³ä»£è¡¨æ‚¨å·²æˆå¹´ã€‚</p>
                <button onclick="agreeDisclaimer()" style="background:var(--accent-color); color:white; border:none; padding:12px; border-radius:25px; width:100%; font-weight:bold; cursor:pointer;">æˆ‘åŒæ„ä¸¦é€²å…¥</button>
            </div>
        </div>

        <header>
            <span onclick="toggleSidebar(event)" style="cursor:pointer; padding:5px 15px; font-size:20px;">â˜°</span>
            æš–æ¸¯é‡ HA TALK
            <span style="width:50px;"></span>
        </header>
        
        <div id="typing-status"></div>
        <div id="chat-box"></div>
        
        <div id="input-area" onclick="event.stopPropagation()">
            <input id="msg" placeholder="è«‹å…ˆé…å°..." disabled autocomplete="off">
            <button id="btn" onclick="handleAction()" disabled>é–‹å§‹</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const typingStatus = document.getElementById('typing-status');

        // Sidebar é‚è¼¯
        function toggleSidebar(e) {
            e.stopPropagation();
            document.getElementById('sidebar').classList.toggle('open');
            gtag('event', 'toggle_sidebar');
        }
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
        }

        function agreeDisclaimer() {
            gtag('event', 'agree_disclaimer');
            document.getElementById('disclaimer-modal').style.display = 'none';
            if (socket.connected) startSearch();
            else socket.on('connect', startSearch);
        }

        function handleAction() {
            if (!currentRoom) startSearch();
            else sendMsg();
        }

        function startSearch() {
            gtag('event', 'start_match');
            socket.emit('start_chat');
            mainBtn.innerText = 'æœå°‹ä¸­';
            mainBtn.disabled = true;
            chatBox.innerHTML = ''; 
            addSystemMsg('æ­£åœ¨ç‚ºæ‚¨è‡ªå‹•æœå°‹èŠå¤©å°è±¡...');
        }

        socket.on('matched', (data) => {
            gtag('event', 'match_success', { room_id: data.roomId });
            currentRoom = data.roomId;
            chatBox.innerHTML = ''; 
            addSystemMsg('é…å°æˆåŠŸï¼ç›¡æƒ…èŠèŠå§');
            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
        });

        function sendMsg() {
            const text = msgInput.value.trim();
            if(!text) return;
            gtag('event', 'send_message');
            socket.emit('send_msg', { roomId: currentRoom, msg: text });
            addMsg(text, 'me');
            msgInput.value = '';
            socket.emit('stop_typing', { roomId: currentRoom });
        }

        msgInput.addEventListener('input', () => {
            if (currentRoom) socket.emit('typing', { roomId: currentRoom });
        });
        msgInput.addEventListener('focus', () => {
            if (currentRoom) socket.emit('msg_read', { roomId: currentRoom });
        });

        socket.on('receive_msg', (text) => {
            typingStatus.innerText = '';
            addMsg(text, 'partner');
            if (document.hasFocus()) socket.emit('msg_read', { roomId: currentRoom });
        });

        socket.on('partner_read', () => {
            const lastMyMsg = chatBox.querySelector('.me-wrapper:last-child .read-status');
            if (lastMyMsg) lastMyMsg.innerText = 'å·²è®€';
        });

        socket.on('partner_typing', () => { typingStatus.innerText = 'å°æ–¹è«—ç·Šé»è¦†ä½ ...'; });
        socket.on('partner_stop_typing', () => { typingStatus.innerText = ''; });

        socket.on('partner_left', () => {
            gtag('event', 'partner_left');
            addSystemMsg('å°æ–¹å·²é›¢é–‹ã€‚');
            currentRoom = null;
            msgInput.disabled = true;
            msgInput.value = '';
            mainBtn.innerText = 'é–‹å§‹';
        });

        function addMsg(text, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `msg-wrapper ${type === 'me' ? 'me-wrapper' : ''} ${type}`;
            wrapper.innerHTML = `<div class="msg ${type}">${text}</div>` + (type === 'me' ? '<div class="read-status"></div>' : '');
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
        }

        msgInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !msgInput.disabled) handleAction();
        });
    </script>
</body>
</html>