<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>暖港野 HA TALK</title>
    <style>
        /* 沿用你原本的 CSS，這裡省略以節省篇幅 */
        /* 請確保包含原本的樣式 */
        :root { --bg-color: #6a6461; --header-color: #8c8485; --my-msg: #4e6579; --partner-msg: #8c8485; --accent-color: #a08bab; --text-white: #ffffff; }
        body { font-family: sans-serif; margin: 0; background: var(--bg-color); height: 100vh; height: 100dvh; display: flex; flex-direction: column; color: white; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; }
        #input-area { background: var(--header-color); padding: 10px; display: flex; gap: 8px; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: none; }
        .system { text-align: center; color: #ccc; font-size: 12px; margin: 10px 0; }
        .msg-wrapper { display: flex; flex-direction: column; margin-bottom: 10px; }
        .me { align-self: flex-end; background: var(--my-msg); padding: 10px; border-radius: 15px; }
        .partner { align-self: flex-start; background: var(--partner-msg); padding: 10px; border-radius: 15px; }
        #status-bar { display: none; background: #e6b800; color: #333; text-align: center; padding: 5px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="status-bar">⚠️ 網絡不穩，嘗試重連中...</div>
    <div id="chat-box"></div>
    <div id="input-area">
        <button id="end-btn" onclick="endChat()" style="display:none;">離開</button>
        <input id="msg" placeholder="搵到人先可以傾計..." disabled>
        <button id="btn" onclick="handleAction()">開始</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // 1️⃣ 生成或讀取「身份證」 (UUID)
        let myUserId = localStorage.getItem('ha_talk_uid');
        if (!myUserId) {
            myUserId = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            localStorage.setItem('ha_talk_uid', myUserId);
        }

        // 2️⃣ 連線時帶上身份證 (auth token)
        const socket = io({
            auth: { token: myUserId }, // 關鍵：告訴 Server 我是誰
            reconnection: true,
            timeout: 10000,
        });

        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const statusBar = document.getElementById('status-bar');
        let currentRoom = null;

        function handleAction() {
            if (!currentRoom) {
                socket.emit('start_chat');
                mainBtn.innerText = '搵緊人...';
                mainBtn.disabled = true;
                addSystemMsg('正在配對中...');
            } else {
                sendMsg();
            }
        }

        function sendMsg() {
            const text = msgInput.value.trim();
            if (!text) return;
            
            // 鎖定輸入避免重複發送
            msgInput.disabled = true;

            // 3️⃣ 這裡用 Callback 確認發送成功
            socket.emit('send_msg', { msg: text }, (response) => {
                msgInput.disabled = false;
                msgInput.focus();
                if (response.status === 'ok') {
                    addMsg(text, 'me');
                    msgInput.value = '';
                } else {
                    addSystemMsg('❌ 傳送失敗，請重試');
                }
            });

            // 前端超時保護
            setTimeout(() => { if(msgInput.disabled) msgInput.disabled = false; }, 3000);
        }

        function endChat() {
            socket.emit('end_chat');
            resetChat();
        }

        function resetChat() {
            currentRoom = null;
            mainBtn.innerText = '開始';
            mainBtn.disabled = false;
            msgInput.disabled = true;
            document.getElementById('end-btn').style.display = 'none';
            addSystemMsg('對話已結束');
        }

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg-wrapper ${type}`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- Socket 事件監聽 ---

        socket.on('matched', (data) => {
            currentRoom = data.roomId;
            chatBox.innerHTML = '';
            addSystemMsg('✅ 搵到人喇！開始傾計啦');
            msgInput.disabled = false;
            mainBtn.innerText = '傳送';
            mainBtn.disabled = false;
            document.getElementById('end-btn').style.display = 'block';
        });

        socket.on('receive_msg', (data) => {
            addMsg(data.msg, 'partner');
        });

        socket.on('partner_left', (data) => {
            addSystemMsg(data.msg);
            resetChat();
        });

        socket.on('partner_status', (data) => {
            // 當對方斷線或重連時的通知
            addSystemMsg(`ℹ️ ${data.msg}`);
        });

        // 4️⃣ 處理重連恢復
        socket.on('connection_recovered', (data) => {
            console.log('Session restored');
            currentRoom = data.roomId;
            statusBar.style.display = 'none';
            msgInput.disabled = false;
            mainBtn.innerText = '傳送';
            addSystemMsg('✅ 網絡已恢復，可以繼續對話');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected');
            statusBar.style.display = 'block';
            msgInput.disabled = true; // 斷線時禁止輸入
        });

        socket.on('connect', () => {
            console.log('Connected');
            statusBar.style.display = 'none';
            // 連線後，如果原本不在房間，不需要做特別的事
            // 如果原本在房間，後端會觸發 connection_recovered
        });

        // 監聽 Enter 鍵
        msgInput.addEventListener("keypress", (e) => { 
            if (e.key === "Enter") sendMsg(); 
        });
    </script>
</body>
</html>