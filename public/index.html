<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>質感匿名聊天室</title>
    <style>
        /* 應用你的 Pantone 色卡 */
        :root {
            --bg-color: #6a6461;       /* Hematite 17-5800 */
            --header-color: #8c8485;   /* Cloud Cover 16-1523 */
            --my-msg: #4e6579;         /* Blue Fusion 18-4218 */
            --partner-msg: #8c8485;    /* Cloud Cover 16-1523 */
            --accent-color: #a08bab;    /* Quiet Violet 16-3610 */
            --text-white: #ffffff;
            --system-bg: rgba(0, 0, 0, 0.2);
        }

        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; 
            background: var(--bg-color); 
            height: 100vh; 
            display: flex; 
            flex-direction: column;
            color: var(--text-white);
        }

        header { 
            background: var(--header-color); 
            padding: 15px; 
            text-align: center; 
            font-weight: bold; 
            border-bottom: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #chat-box { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        /* 對話氣泡 */
        .msg { 
            max-width: 75%; 
            padding: 12px 16px; 
            border-radius: 20px; 
            font-size: 15px; 
            line-height: 1.4;
            word-wrap: break-word; 
        }
        .msg.me { 
            align-self: flex-end; 
            background: var(--my-msg); 
            color: white; 
            border-bottom-right-radius: 4px; 
        }
        .msg.partner { 
            align-self: flex-start; 
            background: var(--partner-msg); 
            color: white; 
            border-bottom-left-radius: 4px; 
        }
        .system { 
            align-self: center; 
            font-size: 12px; 
            color: #d1d1d1; 
            background: var(--system-bg); 
            padding: 6px 14px; 
            border-radius: 12px; 
            text-align: center; 
        }

        #input-area { 
            background: var(--header-color); 
            padding: 12px; 
            display: flex; 
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-bottom: calc(12px + env(safe-area-inset-bottom)); 
        }
        
        input { 
            flex: 1; 
            border: none; 
            background: rgba(255,255,255,0.15); 
            padding: 12px 18px; 
            border-radius: 25px; 
            outline: none; 
            font-size: 16px; 
            color: white;
        }
        input::placeholder { color: rgba(255,255,255,0.6); }

        button { 
            background: var(--accent-color); 
            border: none; 
            color: white; 
            font-weight: bold; 
            padding: 0 20px; 
            margin-left: 10px;
            border-radius: 25px;
            cursor: pointer; 
            transition: opacity 0.2s;
        }
        button:disabled { background: #555; cursor: not-allowed; }
        button:active { opacity: 0.8; }
    </style>
</head>
<body>
    <header>質感匿名聊天室</header>
    <div id="chat-box">
        <div class="system">點擊「開始」尋找聊天對象</div>
    </div>
    <div id="input-area">
        <input id="msg" placeholder="請先配對..." disabled>
        <button id="btn" onclick="handleAction()">開始</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({ transports: ['websocket'] });
        let currentRoom = null;
        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');

        function handleAction() {
            if (!currentRoom) {
                startSearch();
            } else {
                sendMsg();
            }
        }

        function startSearch() {
            socket.emit('start_chat');
            mainBtn.innerText = '搜尋中';
            mainBtn.disabled = true;
            addSystemMsg('正在為您搜尋聊天對象...');
        }

        socket.on('matched', (data) => {
            currentRoom = data.roomId;
            chatBox.innerHTML = ''; 
            addSystemMsg('配對成功！盡情聊聊吧');
            msgInput.disabled = false;
            msgInput.placeholder = "輸入訊息...";
            mainBtn.innerText = '傳送';
            mainBtn.disabled = false;
        });

        function sendMsg() {
            const text = msgInput.value.trim();
            if(!text) return;
            socket.emit('send_msg', { roomId: currentRoom, msg: text });
            addMsg(text, 'me');
            msgInput.value = '';
        }

        socket.on('receive_msg', (text) => addMsg(text, 'partner'));

        socket.on('partner_left', () => {
            addSystemMsg('對方已離開。');
            currentRoom = null;
            msgInput.disabled = true;
            msgInput.value = "";
            msgInput.placeholder = "請重新配對...";
            mainBtn.innerText = '開始';
            mainBtn.disabled = false;
        });

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        msgInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !msgInput.disabled) handleAction();
        });
    </script>
</body>
</html>