<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æš–æ¸¯é‡ HA TALK</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03QD2SY1QM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03QD2SY1QM');
    </script>

    <style>
        :root {
            --bg-color: #6a6461; --header-color: #8c8485;
            --my-msg: #4e6579; --partner-msg: #8c8485;
            --accent-color: #a08bab; --text-white: #ffffff;
            --sidebar-bg: #4a4542;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            background: var(--bg-color); 
            height: 100vh; height: 100dvh; 
            display: flex; color: var(--text-white); 
            overflow: hidden; overscroll-behavior: none; 
        }
        
        #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: 0.3s ease; z-index: 2000; position: absolute; left: -260px; height: 100%; }
        #sidebar.open { left: 0; }
        .sidebar-header { padding: 25px 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-item { padding: 15px 20px; color: #ddd; text-decoration: none; display: block; cursor: pointer; }
        .menu-item.active { background: var(--accent-color); color: white; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500; }
        #sidebar.open ~ #overlay { display: block; }

        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; transition: 0.3s; width: 100%; height: 100%; }
        header { background: var(--header-color); padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; flex-shrink: 0; }
        
        #status-bar {
            display: none;
            background: #e6b800;
            color: #333;
            font-size: 12px;
            text-align: center;
            padding: 4px;
            font-weight: bold;
        }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        
        .joke-fade { animation: fadeIn 0.8s ease-in-out; background: rgba(160, 139, 171, 0.15) !important; border-left: 4px solid var(--accent-color); border-radius: 8px; padding: 12px 16px !important; max-width: 85%; margin: 15px auto !important; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); text-align: left; line-height: 1.6; }
        .joke-fade small { color: var(--accent-color); font-weight: bold; font-size: 11px; }

        .suggestion-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 10px 0; }
        .topic-btn { background: var(--accent-color); color: white; border: none; padding: 10px 16px; border-radius: 15px; font-size: 14px; cursor: pointer; transition: 0.2s; -webkit-tap-highlight-color: transparent; user-select: none; }
        .topic-btn:active { opacity: 0.7; transform: scale(0.95); }

        #typing-status { font-size: 12px; color: #d1d1d1; padding: 5px 20px; height: 20px; font-style: italic; background: rgba(0,0,0,0.05); flex-shrink: 0; }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; }
        .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.partner { align-self: flex-start; }
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.me { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .msg.partner { background: var(--partner-msg); border-bottom-left-radius: 4px; }
        .read-status { font-size: 10px; color: #ccc; margin-top: 2px; height: 12px; }
        .system { align-self: center; font-size: 12px; color: #d1d1d1; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 12px; text-align: center; margin: 5px 0; }
        .msg-sending { opacity: 0.6; } /* ç™¼é€ä¸­æ¨£å¼ */

        #end-btn { background: rgba(220, 60, 60, 0.9); border: none; color: white; font-weight: bold; padding: 0 16px; margin-right: 8px; border-radius: 25px; cursor: pointer; font-size: 14px; transition: 0.2s; flex-shrink: 0; min-width: 50px; }
        #end-btn:active { background: rgba(200, 40, 40, 1); transform: scale(0.95); }

        #input-area { background: var(--header-color); padding: 10px; display: flex; gap: 8px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); flex-shrink: 0; }
        input { flex: 1; border: none; background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 25px; color: white; outline: none; font-size: 16px; min-width: 0; }
        button#btn { background: var(--accent-color); border: none; color: white; font-weight: bold; padding: 0 20px; border-radius: 25px; cursor: pointer; flex-shrink: 0; min-width: 60px; }
        button#btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #disclaimer-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; color: #333; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">æš–æ¸¯é‡ HA TALK</div>
        <div class="menu-item active" onclick="closeSidebar()">ğŸ  å³æ™‚é…å°èŠå¤©</div>
        <a href="https://www.threads.net/@hatalk_canton" target="_blank" class="menu-item">ğŸ§µ Threads ç¤¾ç¾¤</a>
        <a href="https://www.instagram.com/hatalk_canton" target="_blank" class="menu-item">ğŸ“¸ æŠ•ç¨¿å°è©± (IG)</a>
    </div>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div id="main-container">
        <div id="disclaimer-modal">
            <div class="modal-content">
                <h3 style="color:var(--accent-color)">ä½¿ç”¨é ˆçŸ¥èˆ‡å…è²¬è²æ˜</h3>
                <p style="text-align:left; font-size:14px; color:#666;">1. åš´ç¦é¨·æ“¾ã€è©é¨™æˆ–éæ³•è¡Œç‚ºã€‚<br>2. ç³»çµ±ä¸å„²å­˜å°è©±ã€‚<br>3. é»æ“ŠåŒæ„å³ä»£è¡¨æ‚¨å·²æˆå¹´ã€‚</p>
                <button onclick="agreeDisclaimer()" style="background:var(--accent-color); color:white; border:none; padding:12px; border-radius:25px; width:100%; font-weight:bold; cursor:pointer;">æˆ‘åŒæ„ä¸¦é€²å…¥</button>
            </div>
        </div>

        <header>
            <span onclick="toggleSidebar(event)" style="cursor:pointer; padding:5px 15px; font-size:20px;">â˜°</span>
            æš–æ¸¯é‡ HA TALK
            <span style="width:50px;"></span>
        </header>

        <div id="status-bar">âš ï¸ ç¶²çµ¡ä¸ç©©ï¼Œå˜—è©¦é‡é€£ä¸­...</div>
        
        <div id="chat-box"></div>
        <div id="typing-status"></div>
        
        <div id="input-area">
            <button id="end-btn" onclick="endChat()" style="display:none;">é›¢é–‹</button>
            <input id="msg" placeholder="æµåˆ°äººå…ˆå¯ä»¥å‚¾è¨ˆ..." disabled autocomplete="off">
            <button id="btn" onclick="handleAction()" disabled>é–‹å§‹</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // âš¡ï¸ åˆå§‹åŒ– Socket.io
        const socket = io({
            reconnection: true, 
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            timeout: 20000,
            transports: ['websocket', 'polling']
        });

        // âš¡ï¸ Wake Lock: å˜—è©¦ä¿æŒè¢å¹•å¸¸äº®
        let wakeLock = null;
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            }
        }

        const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        const statusBar = document.getElementById('status-bar');

        let originalTitle = document.title;
        let flashInterval = null;
        let currentRoom = null;
        let typingTimeout = null;
        let waitTimer = null; 
        let isInChat = false;

        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const typingStatus = document.getElementById('typing-status');

        // ... (ä¿ç•™åŸæœ¬çš„ Title Flash å’Œ waitContent é‚è¼¯) ...
        function startTitleFlash() {
            if (flashInterval) return;
            let isOriginal = true;
            flashInterval = setInterval(() => {
                document.title = isOriginal ? "ğŸ”” ä½ æœ‰æ–°è¨Šæ¯ï¼" : originalTitle;
                isOriginal = !isOriginal;
            }, 1000);
        }
        function stopTitleFlash() {
            if (flashInterval) {
                clearInterval(flashInterval);
                flashInterval = null;
                document.title = originalTitle;
            }
        }
        
        const waitContent = [
            { type: "æ€¥å£ä»¤", text: "å…¥å¯¦é©—å®¤ï¼Œæ’³ç·Šæ€¥æ£ã€‚" },
            { type: "çˆ›gag", text: "é»è§£å°æ˜è·‘å¾—å¿«éç«è»Šï¼Ÿ<br>... å› ç‚ºå°æ˜å–ºç«è»Šå…¥é¢è·‘ã€‚" },
            { type: "å°è²¼å£«", text: "è¬ä¸€å””çŸ¥å‚¾å’©å¥½ï¼Œå¯ä»¥ç”¨æˆ‘å“‹æä¾›å˜…ã€è©±é¡Œå»ºè­°ã€æ£ï¼" }
            // ... ä½ å¯ä»¥è‡ªå·±åŠ å›åŸæœ¬é‚£äº›å…§å®¹
        ];

        function toggleSidebar(e) { e.stopPropagation(); document.getElementById('sidebar').classList.toggle('open'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

        function agreeDisclaimer() {
            document.getElementById('disclaimer-modal').style.display = 'none';
            requestWakeLock(); // è«‹æ±‚è¢å¹•å¸¸äº®
            if (socket.connected) {
                startSearch(); 
            } else {
                mainBtn.innerText = 'é€£ç·šä¸­...';
                socket.autoStart = true;
            }
        }

        function handleAction() {
            if (mainBtn.dataset.action === 'reload') {
                window.location.reload();
                return;
            }
            if (!currentRoom) startSearch();
            else sendMsg();
        }

        function startSearch() {
            if (waitTimer) clearInterval(waitTimer);
            removeTopicButtons();
            
            socket.emit('start_chat');
            mainBtn.innerText = 'æµç·Šäºº';
            mainBtn.disabled = true;
            chatBox.innerHTML = ''; 
            removeEndChatButton();
            isInChat = false;
            
            addSystemMsg('ç­‰é™£å“ˆï¼Œå¹«ä½ æµç·ŠäººåŒä½ å‚¾è¨ˆ...');

            const showJoke = () => {
                const item = waitContent[Math.floor(Math.random() * waitContent.length)];
                const oldJoke = document.querySelector('.joke-fade');
                if (oldJoke) oldJoke.remove();
                
                const jokeDiv = document.createElement('div');
                jokeDiv.className = 'joke-fade';
                jokeDiv.innerHTML = `<small>[${item.type}]</small><br>${item.text}`;
                chatBox.appendChild(jokeDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            };

            showJoke();
            waitTimer = setInterval(showJoke, 5000); 
        }

        socket.on('matched', (data) => {
            if (waitTimer) {
                clearInterval(waitTimer);
                waitTimer = null;
            }
            
            currentRoom = data.roomId;
            isInChat = true;
            chatBox.innerHTML = ''; 
            addSystemMsg('æµåˆ°äººå–‡ï¼é–‹å£å‚¾ä¸‹è¨ˆå•¦ ğŸ’¬');
            
            if (data.topics && data.topics.length > 0) createTopicButtons(data.topics);

            showEndChatButton();
            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            msgInput.focus();
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
            
            // é‡æ–°è«‹æ±‚ Wake Lock
            requestWakeLock();
        });

        // âš¡ï¸ æ ¸å¿ƒä¿®æ­£ï¼šç™¼é€è¨Šæ¯æ”¹ç”¨ Callback æ¨¡å¼
        function sendMsg() {
            const text = msgInput.value.trim();
            if(!text || !currentRoom) return;
            if (text.length > 1000) { addSystemMsg('âš ï¸ è¨Šæ¯å¤ªé•·'); return; }
            
            // æš«æ™‚é–å®šæŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡ç™¼é€
            mainBtn.disabled = true;

            // è¨­ç½®ä¸€å€‹å‰ç«¯è¶…æ™‚ä¿è­· (å¦‚æœä¼ºæœå™¨3ç§’æ²’å›æ‡‰)
            const timeoutCheck = setTimeout(() => {
                if (mainBtn.disabled) {
                    mainBtn.disabled = false;
                    addSystemMsg('âš ï¸ ç¶²çµ¡ä¸ç©©ï¼Œå‚³é€å¤±æ•—ï¼Œè«‹é‡è©¦');
                }
            }, 3000);

            socket.emit('send_msg', { roomId: currentRoom, msg: text }, (response) => {
                clearTimeout(timeoutCheck); // æ¸…é™¤è¶…æ™‚æª¢æŸ¥
                mainBtn.disabled = false;
                
                if (response && response.status === 'ok') {
                    // ä¼ºæœå™¨ç¢ºèªæ”¶åˆ°ï¼Œæ‰é¡¯ç¤ºåœ¨ç•«é¢ä¸Š
                    addMsg(text, 'me');
                    msgInput.value = '';
                    socket.emit('stop_typing', { roomId: currentRoom });
                    removeTopicButtons();
                    msgInput.focus();
                } else {
                    addSystemMsg('âŒ å‚³é€å¤±æ•—ï¼š' + (response.msg || 'æœªçŸ¥éŒ¯èª¤'));
                }
            });
        }

        // ... Topic Buttons é‚è¼¯ ...
        function createTopicButtons(topics) {
            const container = document.createElement('div');
            container.className = 'suggestion-container';
            topics.forEach(topic => {
                const btn = document.createElement('button');
                btn.className = 'topic-btn';
                btn.innerText = topic;
                btn.addEventListener('click', function() {
                    msgInput.value = topic;
                    sendMsg();
                    removeTopicButtons();
                });
                container.appendChild(btn);
            });
            chatBox.appendChild(container);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeTopicButtons() {
            const containers = document.querySelectorAll('.suggestion-container');
            containers.forEach(c => c.remove());
        }

        msgInput.addEventListener('input', () => { 
            if (currentRoom) {
                socket.emit('typing', { roomId: currentRoom });
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => { 
                    socket.emit('stop_typing', { roomId: currentRoom }); 
                }, 2000);
            }
        });

        socket.on('receive_msg', (data) => {
            typingStatus.innerText = '';
            const text = typeof data === 'string' ? data : data.msg;
            addMsg(text, 'partner');
            socket.emit('msg_read', { roomId: currentRoom });
            
            if (document.hidden) {
                notificationSound.play().catch(() => {});
                startTitleFlash();
            }
        });

        // ... å…¶ä»– Socket äº‹ä»¶ ...
        socket.on('partner_read', () => {
            const lastMyMsg = chatBox.querySelector('.msg-wrapper.me:last-child .read-status');
            if (lastMyMsg) lastMyMsg.innerText = 'å·²è®€';
        });

        socket.on('partner_typing', () => { typingStatus.innerText = 'å°æ–¹è«—ç·Šé»è¦†ä½ ...'; });
        socket.on('partner_stop_typing', () => { typingStatus.innerText = ''; });
        socket.on('partner_status', (data) => { typingStatus.innerText = data.msg; });

        socket.on('connection_recovered', (data) => {
            console.log('Connection recovered');
            statusBar.style.display = 'none';
            currentRoom = data.roomId;
            isInChat = true;
            
            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
            showEndChatButton();
            addSystemMsg('âœ… é€£ç·šå·²æ¢å¾©ï¼Œå¯ä»¥ç¹¼çºŒå°è©±');
            requestWakeLock();
        });

        socket.on('partner_left', (data) => {
            if (waitTimer) clearInterval(waitTimer);
            addSystemMsg(data.msg || 'å°æ–¹èµ°å’—å–‡ã€‚');
            showRematchButton();
            resetToIdle();
        });

        socket.on('chat_ended', (data) => {
            if (waitTimer) clearInterval(waitTimer);
            addSystemMsg(data.msg || 'å°è©±å·²çµæŸ');
            showRematchButton();
            resetToIdle();
        });

        function showRematchButton() {
            const oldBtns = document.querySelectorAll('.rematch-button-container');
            oldBtns.forEach(btn => btn.remove());
            const btnDiv = document.createElement('div');
            btnDiv.className = 'rematch-button-container';
            btnDiv.style.textAlign = 'center';
            btnDiv.style.margin = '20px 0';
            btnDiv.innerHTML = `<button onclick="startSearch()" style="background:var(--accent-color); color:white; border:none; padding:14px 28px; border-radius:25px; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.2); font-size:15px; cursor:pointer;">ğŸ”„ å°‹æ‰¾ä¸‹ä¸€å€‹</button>`;
            chatBox.appendChild(btnDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function resetToIdle() {
            currentRoom = null;
            isInChat = false;
            msgInput.disabled = true;
            msgInput.placeholder = "æµåˆ°äººå…ˆå¯ä»¥å‚¾è¨ˆ...";
            msgInput.value = '';
            mainBtn.innerText = 'é–‹å§‹';
            mainBtn.disabled = false;
            mainBtn.dataset.action = ''; 
            typingStatus.innerText = '';
            removeEndChatButton();
            removeTopicButtons();
        }

        function showEndChatButton() { document.getElementById('end-btn').style.display = 'block'; }
        function removeEndChatButton() { document.getElementById('end-btn').style.display = 'none'; }

        function endChat() {
            if (!currentRoom) return;
            if (confirm('çœŸä¿‚è¦é›¢é–‹ï¼Ÿå°æ–¹æœƒå¥½å‚·å¿ƒã—å– ğŸ¥º')) {
                socket.emit('end_chat');
                addSystemMsg('ä½ å·²é›¢é–‹å°è©±');
                showRematchButton();
                resetToIdle();
            }
        }

        function addMsg(text, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `msg-wrapper ${type === 'me' ? 'me-wrapper' : ''} ${type}`;
            const safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
            wrapper.innerHTML = `<div class="msg ${type}">${safeText}</div>` + (type === 'me' ? '<div class="read-status"></div>' : '');
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        msgInput.addEventListener("keypress", (e) => { 
            if (e.key === "Enter" && !e.shiftKey && !msgInput.disabled) {
                e.preventDefault();
                handleAction(); 
            }
        });

        // âš¡ï¸ é€£ç·šç‹€æ…‹è™•ç†
        socket.on('disconnect', (reason) => {
            console.log('Disconnected:', reason);
            if (waitTimer) clearInterval(waitTimer);
            statusBar.style.display = 'block';
            statusBar.textContent = 'âš ï¸ ç¶²çµ¡ä¸ç©©ï¼Œå˜—è©¦é‡é€£ä¸­...';
        });

        socket.on('connect', () => {
            console.log('Connected');
            statusBar.style.display = 'none';
            if (socket.autoStart) { startSearch(); delete socket.autoStart; } 
            else if (mainBtn.dataset.action === 'reload') { resetToIdle(); }
            else if (isInChat && !currentRoom) { showRematchButton(); resetToIdle(); }
        });

        // âš¡ï¸ é é¢å¯è¦‹æ€§è™•ç† (è§£æ±ºæ‰‹æ©Ÿåˆ‡æ› App æ–·ç·šå•é¡Œ)
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                stopTitleFlash(); 
                // é‡æ–°ç”³è«‹ Wake Lock
                await requestWakeLock();
                
                // å¼·åˆ¶æª¢æŸ¥é€£ç·š
                if (!socket.connected) {
                    console.log('Page visible, force reconnecting...');
                    statusBar.style.display = 'block';
                    socket.connect();
                }
            }
        });

        window.addEventListener('online', () => {
            if (!socket.connected) socket.connect();
        });

        socket.on('error', (data) => {
            if (data && data.msg) addSystemMsg(`âš ï¸ ${data.msg}`);
        });
    </script>
</body>
</html>