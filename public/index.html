<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æš–æ¸¯é‡ HA TALK - åŒ¿åé…å°èŠå¤©</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03QD2SY1QM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03QD2SY1QM');
    </script>

    <style>
        :root {
            --bg-color: #6a6461; --header-color: #8c8485;
            --my-msg: #4e6579; --partner-msg: #8c8485;
            --accent-color: #a08bab; --text-white: #ffffff;
            --sidebar-bg: #4a4542;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            background: var(--bg-color); 
            height: 100vh; 
            height: 100dvh; 
            display: flex; 
            color: var(--text-white); 
            overflow: hidden; 
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
            /* ğŸ”§ é˜²æ­¢ç§»å‹•ç«¯ç¸®æ”¾ */
            touch-action: pan-y;
        }
        
        #sidebar { 
            width: 260px; 
            background: var(--sidebar-bg); 
            border-right: 1px solid rgba(0,0,0,0.2); 
            display: flex; 
            flex-direction: column; 
            transition: 0.3s ease; 
            z-index: 2000; 
            position: fixed; 
            left: -260px; 
            height: 100%; 
            top: 0;
        }
        #sidebar.open { left: 0; }
        .menu-item { 
            padding: 15px 20px; 
            color: #ddd; 
            text-decoration: none; 
            display: block; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .menu-item:hover, .menu-item:active { 
            background: rgba(255,255,255,0.1); 
        }
        #overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.4); 
            z-index: 1500; 
        }
        #sidebar.open ~ #overlay { display: block; }

        #main-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            width: 100%; 
            height: 100vh;
            height: 100dvh;
        }
        
        header { 
            background: var(--header-color); 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            font-weight: bold; 
            flex-shrink: 0;
            /* ğŸ”§ æ”¯æŒå®‰å…¨å€åŸŸ */
            padding-top: max(15px, env(safe-area-inset-top));
        }
        
        #status-bar { 
            display: none; 
            background: #ff4d4d; 
            color: white; 
            font-size: 12px; 
            text-align: center; 
            padding: 6px; 
            font-weight: bold; 
            animation: slideDown 0.3s; 
        }
        @keyframes slideDown { 
            from { transform: translateY(-100%); } 
            to { transform: translateY(0); } 
        }

        /* ğŸ”§ èŠå¤©æ¡†æ”¹é€² */
        #chat-box { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            scroll-behavior: smooth; 
            /* ğŸ”§ å¢åŠ åº•éƒ¨ç©ºé–“ï¼Œé˜²æ­¢è¢«è¼¸å…¥æ¡†æˆ–æ‰“å­—æŒ‡ç¤ºå™¨é®æ“‹ */
            padding-bottom: 120px;
            -webkit-overflow-scrolling: touch;
        }
        
        .msg-wrapper { 
            display: flex; 
            flex-direction: column; 
            max-width: 75%; 
            position: relative; 
            margin-bottom: 4px; 
        }
        .msg-wrapper.me { 
            align-self: flex-end; 
            align-items: flex-end; 
        }
        .msg-wrapper.partner { 
            align-self: flex-start; 
        }
        
        .msg { 
            padding: 12px 16px; 
            border-radius: 20px; 
            font-size: 15px; 
            line-height: 1.4; 
            word-wrap: break-word; 
            word-break: break-word;
            animation: msgPop 0.2s ease; 
        }
        .msg.me { 
            background: var(--my-msg); 
            border-bottom-right-radius: 4px; 
        }
        .msg.partner { 
            background: var(--partner-msg); 
            border-bottom-left-radius: 4px; 
        }
        @keyframes msgPop { 
            from { opacity: 0; transform: scale(0.8); } 
            to { opacity: 1; transform: scale(1); } 
        }

        .read-status { 
            font-size: 11px; 
            color: rgba(255,255,255,0.6); 
            margin-top: 3px; 
            margin-right: 4px; 
            height: 16px; 
            transition: all 0.3s ease;
        }
        .read-status.show { 
            opacity: 1;
            color: #4CAF50;
            font-weight: 500;
        }

        /* ğŸ”§ æ‰“å­—æŒ‡ç¤ºå™¨æ”¹é€² - å›ºå®šåœ¨è¼¸å…¥æ¡†æ­£ä¸Šæ–¹ */
        #typing-indicator { 
            position: fixed;
            /* ğŸ”§ å‹•æ…‹è¨ˆç®—ä½ç½®ï¼šè¼¸å…¥æ¡†é«˜åº¦ + padding + å®‰å…¨å€åŸŸ */
            bottom: calc(60px + env(safe-area-inset-bottom));
            left: 20px;
            display: none;
            align-items: center;
            gap: 8px;
            background: rgba(140, 132, 133, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            width: fit-content;
            max-width: calc(100% - 40px);
            animation: slideUp 0.3s ease;
            z-index: 50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #typing-indicator.show { display: flex; }
        @keyframes slideUp { 
            from { transform: translateY(20px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        .typing-text { 
            font-size: 13px; 
            color: white; 
            font-style: italic; 
            white-space: nowrap;
        }
        .typing-dots { 
            display: flex; 
            gap: 3px; 
        }
        .typing-dot { 
            width: 6px; 
            height: 6px; 
            background: rgba(255,255,255,0.8); 
            border-radius: 50%; 
            animation: bounce 1.4s infinite ease-in-out both; 
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } 
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 
            0%, 80%, 100% { transform: scale(0); } 
            40% { transform: scale(1); } 
        }

        .rematch-container { 
            text-align: center; 
            margin: 30px 0; 
            animation: fadeIn 0.5s forwards; 
        }
        .rematch-btn {
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 12px 28px;
            border-radius: 30px; 
            font-weight: bold; 
            font-size: 15px; 
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            transition: all 0.2s;
            /* ğŸ”§ é˜²æ­¢é»æ“Šæ™‚ç¸®æ”¾å¤±æ§ */
            -webkit-tap-highlight-color: transparent;
        }
        .rematch-btn:active { transform: scale(0.95); }

        .system { 
            align-self: center; 
            font-size: 12px; 
            color: #d1d1d1; 
            background: rgba(0,0,0,0.2); 
            padding: 6px 14px; 
            border-radius: 12px; 
            text-align: center; 
            margin: 5px 0;
            max-width: 90%;
        }

        /* ğŸ”§ è¼¸å…¥å€åŸŸæ”¹é€² */
        #input-area { 
            background: var(--header-color); 
            padding: 10px; 
            display: flex; 
            gap: 8px; 
            /* ğŸ”§ æ”¯æŒå®‰å…¨å€åŸŸ */
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
            position: relative;
            flex-shrink: 0;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        input { 
            flex: 1; 
            border: none; 
            background: rgba(255,255,255,0.15); 
            padding: 12px 16px; 
            border-radius: 25px; 
            color: white; 
            outline: none; 
            font-size: 16px;
            /* ğŸ”§ é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
            max-width: 100%;
        }
        input::placeholder { 
            color: rgba(255,255,255,0.6); 
        }
        
        button#btn { 
            background: var(--accent-color); 
            border: none; 
            color: white; 
            font-weight: bold; 
            padding: 0 20px; 
            border-radius: 25px; 
            cursor: pointer; 
            min-width: 60px; 
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        button#btn:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
        }
        
        #end-btn { 
            background: rgba(220, 60, 60, 0.9); 
            border: none; 
            color: white; 
            font-weight: bold; 
            padding: 0 16px; 
            border-radius: 25px; 
            cursor: pointer; 
            display: none; 
            transition: all 0.2s;
            flex-shrink: 0;
        }
        #end-btn:active { transform: scale(0.95); }

        .suggestion-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            justify-content: center; 
            margin: 15px 0; 
            padding: 10px;
            animation: fadeInUp 0.5s ease;
        }
        @keyframes fadeInUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .topic-btn { 
            background: linear-gradient(135deg, var(--accent-color), #8a7a9b);
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 20px; 
            font-size: 13px; 
            cursor: pointer; 
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
        }
        .topic-btn:active { 
            transform: scale(0.95); 
        }

        .joke-card { 
            align-self: center;
            background: linear-gradient(135deg, rgba(160, 139, 171, 0.25), rgba(140, 132, 133, 0.25));
            border-left: 4px solid var(--accent-color); 
            padding: 16px 20px;
            margin: 12px 20px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeInScale 0.6s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        @keyframes fadeInScale { 
            from { opacity: 0; transform: scale(0.9) translateY(10px); } 
            to { opacity: 1; transform: scale(1) translateY(0); } 
        }
        
        .joke-label { 
            color: var(--accent-color); 
            font-weight: bold; 
            font-size: 12px; 
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .joke-text { 
            color: #f0f0f0; 
            font-size: 14px; 
            line-height: 1.6;
        }

        #disclaimer-modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            backdrop-filter: blur(5px); 
        }
        .modal-content { 
            background: white; 
            color: #333; 
            padding: 30px; 
            border-radius: 20px; 
            width: 85%; 
            max-width: 400px; 
            text-align: center;
            /* ğŸ”§ é˜²æ­¢åœ¨å°è¢å¹•è¢«æˆªæ–· */
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-btn { 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 25px; 
            font-weight: bold; 
            font-size: 16px; 
            cursor: pointer; 
            margin-top: 15px; 
            width: 100%; 
            transition: all 0.2s; 
        }
        .modal-btn:active { transform: scale(0.98); }

        /* ğŸ”§ ç§»å‹•ç«¯ç‰¹å®šå„ªåŒ– */
        @media (max-width: 768px) {
            .msg-wrapper {
                max-width: 85%;
            }
            
            header {
                padding: 12px 15px;
            }
            
            #chat-box {
                padding: 15px;
            }
        }
    </style>
</head>
<body>

    <div id="disclaimer-modal">
        <div class="modal-content">
            <h2 style="color:var(--accent-color); margin-top:0;">ğŸ‘‹ æ­¡è¿ä¾†åˆ°æš–æ¸¯é‡</h2>
            <div style="text-align:left; font-size:14px; color:#666; line-height:1.6; margin: 20px 0;">
                <p>1. é€™è£¡æ˜¯ä¸€å€‹åŒ¿åé…å°èŠå¤©ç©ºé–“ã€‚</p>
                <p>2. åš´ç¦é¨·æ“¾ã€è©é¨™ã€å»£å‘Šæˆ–éæ³•è¡Œç‚ºã€‚</p>
                <p>3. ç³»çµ±ä¸å„²å­˜å°è©±,é›¢é–‹å³ç„šã€‚</p>
                <p>4. é»æ“ŠæŒ‰éˆ•å³ä»£è¡¨æ‚¨å·²æˆå¹´ä¸¦åŒæ„è¦å‰‡ã€‚</p>
            </div>
            <button class="modal-btn" onclick="agreeDisclaimer()">æˆ‘åŒæ„ä¸¦é–‹å§‹é…å°</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="menu-item" style="border-bottom:1px solid #666; font-weight:bold;">æš–æ¸¯é‡ HA TALK</div>
        <div class="menu-item" onclick="closeSidebar()">ğŸ  å³æ™‚é…å°èŠå¤©</div>
        <a href="https://www.instagram.com/hatalk_canton" target="_blank" class="menu-item">ğŸ“¸ æŠ•ç¨¿ä½ çš„å°è©±</a>
        <a href="https://www.threads.com/@hatalk_canton" target="_blank" class="menu-item">ğŸ§µ Threadsè¨è«–æœ€æ–°è©±é¡Œ</a>
    </div>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div id="main-container">
        <header>
            <span onclick="toggleSidebar(event)" style="cursor:pointer; padding:5px 15px; font-size:20px;">â˜°</span>
            æš–æ¸¯é‡ HA TALK
            <span style="width:50px;"></span>
        </header>

        <div id="status-bar">âš ï¸ ç¶²çµ¡é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</div>
        
        <div id="chat-box"></div>
        
        <div id="typing-indicator">
            <span class="typing-text">å°æ–¹æ‰“ç·Šå­—...</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div id="input-area">
            <button id="end-btn" onclick="endChat()">é›¢é–‹</button>
            <input id="msg" placeholder="è«‹å…ˆå®Œæˆå…è²¬åŒæ„..." disabled autocomplete="off">
            <button id="btn" onclick="handleAction()" disabled>é–‹å§‹</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // === åˆå§‹åŒ– ===
        let myUserId = localStorage.getItem('ha_talk_uid');
        if (!myUserId) {
            myUserId = 'u_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + Math.random().toString(36).substr(2, 5);
            localStorage.setItem('ha_talk_uid', myUserId);
        }

        const socket = io({
            auth: { token: myUserId },
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: Infinity,
            timeout: 10000
        });

        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const statusBar = document.getElementById('status-bar');
        const typingIndicator = document.getElementById('typing-indicator');
        const endBtn = document.getElementById('end-btn');

        let currentRoom = null;
        let waitTimer = null;
        let isSearching = false;
        let typingTimeout = null;

        const waitContent = [
            { type: "æ€¥å£ä»¤", text: "å…¥å¯¦é©—å®¤ï¼Œæ’³ç·Šæ€¥æ£ã€‚" },
            { type: "æ€¥å£ä»¤", text: "éƒµå·®å”å”ï¼Œé€ä¿¡ç´”ç†Ÿï¼Œè¿…é€Ÿé€å‡ºã€‚" },
            { type: "æ€¥å£ä»¤", text: "åºŠè…³æ’ç‰†è§’ï¼Œç‰†è§’æ’åºŠè…³ã€‚" },
            { type: "çˆ›Gag", text: "é»è§£å°æ˜è·‘å¾—å¿«éç«è»Šï¼Ÿ<br><small>å› ç‚ºå°æ˜å–ºç«è»Šå…¥é¢è·‘ã€‚</small>" },
            { type: "çˆ›Gag", text: "å¤§æ˜é¤Šå°æ˜ï¼Œå’é‚Šå€‹é¤Šå¤§æ˜ï¼Ÿ<br><small>ç‹—ï¼ˆå› ç‚ºã€Œä¹…ã€ä»°å¤§æ˜ï¼‰</small>" },
            { type: "çˆ›Gag", text: "é»è§£é›ªç³•æœƒæº¶ï¼Ÿ<br><small>å› ç‚ºä½¢å¤ªè»Ÿå¼±å•¦ï¼</small>" },
            { type: "å†·çŸ¥è­˜", text: "å»£æ±è©±æœ‰ 9 å€‹è²èª¿ï¼š<br>ã€è©©å²è©¦æ™‚å¸‚äº‹å…’ä¼¼å¯ºã€" },
            { type: "å†·çŸ¥è­˜", text: "ã€Œå…«å¦ã€åŸæœ¬ä¿‚æŒ‡å…«å€‹æ–¹ä½ï¼Œ<br>è€Œå®¶è®Šå’—è¬›äººæ˜¯é ğŸ˜„" },
            { type: "æé†’", text: "åŒ¿åèŠå¤©é›–ç„¶å¥½ç©ï¼Œ<br>ä½†è¨˜å¾—éƒ½è¦å°Šé‡å°æ–¹ â¤ï¸" },
            { type: "æé†’", text: "é‡åˆ°å¥‡æ€ªå˜…äººå¯ä»¥éš¨æ™‚é›¢é–‹ï¼Œ<br>å®‰å…¨ç¬¬ä¸€ï¼ğŸ‘" }
        ];

        // ğŸ”§ ç§»å‹•ç«¯éµç›¤è™•ç†
        function scrollToBottom() {
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 100);
        }

        function agreeDisclaimer() {
            document.getElementById('disclaimer-modal').style.display = 'none';
            msgInput.placeholder = "æ­£åœ¨é–‹å§‹é…å°...";
            mainBtn.innerText = 'é…å°ä¸­';
            mainBtn.disabled = true;
            
            if (socket.connected) {
                startSearch(); 
            } else {
                socket.autoStartSearch = true;
            }
        }

        function handleAction() {
            if (!currentRoom && !isSearching) startSearch();
            else if (currentRoom) sendMsg();
        }

        function startSearch() {
            if (isSearching) return;
            isSearching = true;
            currentRoom = null;
            
            if (waitTimer) {
                clearInterval(waitTimer);
                waitTimer = null;
            }
            
            chatBox.innerHTML = '';
            addSystemMsg('ğŸ” æ­£åœ¨ç‚ºä½ æœå°‹å°è±¡...');
            
            socket.emit('start_chat');
            
            mainBtn.innerText = 'æœå°‹ä¸­';
            mainBtn.disabled = true;
            msgInput.disabled = true;
            msgInput.placeholder = "æœå°‹ä¸­...";
            endBtn.style.display = 'none';
            typingIndicator.classList.remove('show');

            const showJoke = () => {
                const old = document.querySelector('.joke-card');
                if (old) old.remove();
                
                const item = waitContent[Math.floor(Math.random() * waitContent.length)];
                const jokeDiv = document.createElement('div');
                jokeDiv.className = 'joke-card';
                jokeDiv.innerHTML = `
                    <div class="joke-label">${item.type}</div>
                    <div class="joke-text">${item.text}</div>
                `;
                chatBox.appendChild(jokeDiv);
                scrollToBottom();
            };
            
            showJoke();
            waitTimer = setInterval(showJoke, 5000);
        }

        function sendMsg() {
            const text = msgInput.value.trim();
            if (!text || !currentRoom) return;

            msgInput.disabled = true;
            mainBtn.disabled = true;

            socket.emit('send_msg', { msg: text }, (response) => {
                msgInput.disabled = false;
                mainBtn.disabled = false;
                msgInput.focus();

                if (response && response.status === 'ok') {
                    addMsg(text, 'me');
                    msgInput.value = '';
                    socket.emit('stop_typing');
                    removeTopicButtons();
                } else {
                    addSystemMsg('âŒ ' + (response?.msg || 'è¨Šæ¯å‚³é€å¤±æ•—'));
                }
            });
        }

        function endChat() {
            if (confirm('ç¢ºå®šè¦çµæŸé€™æ¬¡å°è©±å—ï¼Ÿ')) {
                socket.emit('end_chat');
                resetToIdle();
            }
        }

        function resetToIdle() {
            currentRoom = null;
            isSearching = false;
            
            if (waitTimer) {
                clearInterval(waitTimer);
                waitTimer = null;
            }
            
            msgInput.disabled = true;
            msgInput.value = '';
            msgInput.placeholder = "æŒ‰ã€Œé–‹å§‹ã€é€²è¡Œé…å°...";
            mainBtn.innerText = 'é–‹å§‹';
            mainBtn.disabled = false;
            endBtn.style.display = 'none';
            typingIndicator.classList.remove('show');
            removeTopicButtons();
        }

        function showRematchButton() {
            const oldBtn = document.querySelector('.rematch-container');
            if (oldBtn) oldBtn.remove();
            
            const div = document.createElement('div');
            div.className = 'rematch-container';
            div.innerHTML = `<button class="rematch-btn" onclick="startSearch()">ğŸ”„ æ‰¾ä¸‹ä¸€å€‹</button>`;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        socket.on('connect', () => {
            console.log('âœ… Connected:', myUserId);
            statusBar.style.display = 'none';
            
            if (socket.autoStartSearch) {
                socket.autoStartSearch = false;
                startSearch();
            } else if (!currentRoom && !isSearching) {
                mainBtn.disabled = false;
                mainBtn.innerText = 'é–‹å§‹';
            }
        });

        socket.on('disconnect', () => {
            console.log('âŒ Disconnected');
            statusBar.style.display = 'block';
            mainBtn.disabled = true;
            msgInput.disabled = true;
        });

        socket.on('matched', (data) => {
            console.log('ğŸ‰ Matched:', data.roomId);
            isSearching = false;
            
            if (waitTimer) {
                clearInterval(waitTimer);
                waitTimer = null;
            }
            
            currentRoom = data.roomId;
            chatBox.innerHTML = '';
            addSystemMsg('ğŸ‰ é…å°æˆåŠŸï¼å¤§å®¶æ‰“å€‹æ‹›å‘¼å§');
            
            if (data.topics && data.topics.length > 0) {
                createTopicButtons(data.topics);
            }
            
            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
            endBtn.style.display = 'block';
        });

        socket.on('receive_msg', (data) => {
            typingIndicator.classList.remove('show');
            addMsg(data.msg, 'partner');
            socket.emit('msg_read');
        });

        socket.on('partner_read', () => {
            const myMsgs = document.querySelectorAll('.msg-wrapper.me .read-status');
            if (myMsgs.length > 0) {
                const lastRead = myMsgs[myMsgs.length - 1];
                lastRead.classList.add('show');
                lastRead.innerText = 'âœ“âœ“ å·²è®€';
            }
        });

        socket.on('partner_left', (data) => {
            console.log('ğŸ‘‹ Partner left');
            if (waitTimer) {
                clearInterval(waitTimer);
                waitTimer = null;
            }
            addSystemMsg(data.msg || 'å°æ–¹å·²é›¢é–‹');
            resetToIdle();
            showRematchButton();
        });

        socket.on('chat_ended', (data) => {
            console.log('ğŸ”š Chat ended');
            if (waitTimer) {
                clearInterval(waitTimer);
                waitTimer = null;
            }
            addSystemMsg(data.msg || 'å°è©±å·²çµæŸ');
            resetToIdle();
            showRematchButton();
        });

        socket.on('connection_recovered', (data) => {
            console.log('ğŸ”„ Connection recovered:', data);
            currentRoom = data.roomId;
            isSearching = false;
            statusBar.style.display = 'none';
            
            if (waitTimer) {
                clearInterval(waitTimer);
                waitTimer = null;
            }
            
            addSystemMsg('âœ… ç¶²çµ¡å·²æ¢å¾©ï¼Œå›åˆ°å°è©±ä¸­');
            
            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
            endBtn.style.display = 'block';
        });

        socket.on('partner_typing', () => {
            typingIndicator.classList.add('show');
        });

        socket.on('partner_stop_typing', () => {
            typingIndicator.classList.remove('show');
        });

        socket.on('partner_status', (data) => {
            if (data.status === 'offline') {
                addSystemMsg(data.msg);
                msgInput.disabled = true;
                mainBtn.disabled = true;
            } else if (data.status === 'online') {
                addSystemMsg(data.msg);
                msgInput.disabled = false;
                mainBtn.disabled = false;
            }
        });

        socket.on('waiting', (data) => {
            console.log('â³ Waiting...', data);
        });

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg-wrapper ${type}`;
            
            const readTag = type === 'me' ? '<div class="read-status">âœ“ å·²é€å‡º</div>' : '';
            div.innerHTML = `
                <div class="msg ${type}">${escapeHtml(text)}</div>
                ${readTag}
            `;
            
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function createTopicButtons(topics) {
            removeTopicButtons();
            
            const container = document.createElement('div');
            container.className = 'suggestion-container';
            
            const hint = document.createElement('div');
            hint.style.cssText = 'width: 100%; text-align: center; font-size: 12px; color: #ddd; margin-bottom: 8px;';
            hint.innerText = 'ğŸ’¡ å¯ä»¥ç”¨å‘¢å•²è©±é¡Œé–‹å§‹èŠå¤©ï¼š';
            container.appendChild(hint);
            
            topics.forEach(topic => {
                const btn = document.createElement('button');
                btn.className = 'topic-btn';
                btn.innerText = topic;
                btn.onclick = () => {
                    msgInput.value = topic;
                    msgInput.focus();
                };
                container.appendChild(btn);
            });
            
            chatBox.appendChild(container);
            scrollToBottom();
        }

        function removeTopicButtons() {
            document.querySelectorAll('.suggestion-container').forEach(e => e.remove());
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSidebar(e) { 
            e.stopPropagation(); 
            document.getElementById('sidebar').classList.toggle('open'); 
        }
        
        function closeSidebar() { 
            document.getElementById('sidebar').classList.remove('open'); 
        }

        msgInput.addEventListener('input', () => {
            if (currentRoom) {
                socket.emit('typing');
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => socket.emit('stop_typing'), 2000);
            }
        });

        msgInput.addEventListener("keypress", (e) => { 
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMsg();
            }
        });

        // ğŸ”§ ç§»å‹•ç«¯éµç›¤å½ˆå‡ºæ™‚è‡ªå‹•æ»¾å‹•
        msgInput.addEventListener('focus', () => {
            setTimeout(scrollToBottom, 300);
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if (!socket.connected) {
                    socket.connect();
                }
            }
        });

        document.getElementById('overlay').addEventListener('click', closeSidebar);
    </script>
</body>
</html>