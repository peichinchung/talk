<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æš–æ¸¯é‡ HA TALK</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03QD2SY1QM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03QD2SY1QM');
    </script>

    <style>
        :root {
            --bg-color: #6a6461; --header-color: #8c8485;
            --my-msg: #4e6579; --partner-msg: #8c8485;
            --accent-color: #a08bab; --text-white: #ffffff;
            --sidebar-bg: #4a4542;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg-color); height: 100vh; display: flex; color: var(--text-white); overflow: hidden; }
        
        /* Side Bar Style */
        #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: transform 0.3s ease; }
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 18px; }
        .sidebar-menu { flex: 1; padding: 10px; }
        .menu-item { padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; color: #ddd; text-decoration: none; display: block; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: var(--accent-color); color: white; }

        /* Main Chat Area */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { background: var(--header-color); padding: 15px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        
        #typing-status { font-size: 12px; color: #d1d1d1; padding: 5px 20px; height: 18px; font-style: italic; background: rgba(0,0,0,0.1); }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Message Bubbles */
        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; }
        .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.partner { align-self: flex-start; }
        
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; position: relative; }
        .msg.me { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .msg.partner { background: var(--partner-msg); border-bottom-left-radius: 4px; }
        
        .read-status { font-size: 10px; color: #ccc; margin-top: 2px; }
        .system { align-self: center; font-size: 12px; color: #d1d1d1; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 12px; }

        #input-area { background: var(--header-color); padding: 12px; display: flex; border-top: 1px solid rgba(0,0,0,0.1); padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        input { flex: 1; border: none; background: rgba(255,255,255,0.15); padding: 12px 18px; border-radius: 25px; color: white; outline: none; }
        button { background: var(--accent-color); border: none; color: white; font-weight: bold; padding: 0 20px; margin-left: 10px; border-radius: 25px; cursor: pointer; }
        
        /* Mobile adjustment */
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: -260px; height: 100%; z-index: 100; }
            #sidebar.open { transform: translateX(260px); }
        }

        #disclaimer-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; color: #333; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">æš–æ¸¯é‡ HA TALK</div>
        <div class="sidebar-menu">
            <a href="#" class="menu-item active">å³æ™‚é…å°èŠå¤©</a>
            <a href="https://threads.net/@hatalk_canton" target="_blank" class="menu-item">HA-TALK ç¤¾ç¾¤ (Threads)</a>
            <a href="https://www.instagram.com/hatalk_canton" target="_blank" class="menu-item">HA-TALK æŠ•ç¨¿å°è©± ğŸ“¸</a>
        </div>
        <div style="padding: 20px; font-size: 11px; color: #888;">Â© 2026 æš–æ¸¯é‡ HA TALK</div>
    </div>

    <div id="main-container">
        <div id="disclaimer-modal">
            <div class="modal-content">
                <h3 style="color:var(--accent-color)">ä½¿ç”¨é ˆçŸ¥èˆ‡å…è²¬è²æ˜</h3>
                <p style="text-align:left; font-size:14px; color:#666;">1. åš´ç¦è‰²æƒ…é¨·æ“¾èˆ‡è©é¨™ã€‚<br>2. ç³»çµ±ä¸å„²å­˜ä»»ä½•å°è©±ç´€éŒ„ã€‚<br>3. æŠ•ç¨¿å°è©±å‰è«‹å‹™å¿…å°‡å°æ–¹æš±ç¨±æ‰“ç¢¼ã€‚</p>
                <button onclick="agreeDisclaimer()" style="width:100%; height:45px; margin-top:10px;">æˆ‘åŒæ„ä¸¦é€²å…¥</button>
            </div>
        </div>

        <header>
            <span onclick="toggleSidebar()" style="cursor:pointer;">â˜°</span>
            æš–æ¸¯é‡ HA TALK
            <span style="width:20px;"></span>
        </header>
        
        <div id="typing-status"></div>
        <div id="chat-box"></div>
        
        <div id="input-area">
            <input id="msg" placeholder="è«‹å…ˆé…å°..." disabled autocomplete="off">
            <button id="btn" onclick="handleAction()" disabled>é–‹å§‹</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const typingStatus = document.getElementById('typing-status');

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function agreeDisclaimer() {
            document.getElementById('disclaimer-modal').style.display = 'none';
            if (socket.connected) startSearch();
            else socket.on('connect', startSearch);
        }

        function handleAction() {
            if (!currentRoom) startSearch();
            else sendMsg();
        }

        function startSearch() {
            socket.emit('start_chat');
            mainBtn.innerText = 'æœå°‹ä¸­';
            mainBtn.disabled = true;
            chatBox.innerHTML = ''; 
            addSystemMsg('æ­£åœ¨ç‚ºæ‚¨è‡ªå‹•æœå°‹èŠå¤©å°è±¡...');
        }

        socket.on('matched', (data) => {
            currentRoom = data.roomId;
            chatBox.innerHTML = ''; 
            addSystemMsg('é…å°æˆåŠŸï¼ç›¡æƒ…èŠèŠå§');
            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
        });

        function sendMsg() {
            const text = msgInput.value.trim();
            if(!text) return;
            socket.emit('send_msg', { roomId: currentRoom, msg: text });
            addMsg(text, 'me');
            msgInput.value = '';
        }

        // æ‰“å­—èˆ‡å·²è®€é‚è¼¯
        msgInput.addEventListener('input', () => {
            if (currentRoom) socket.emit('typing', { roomId: currentRoom });
        });

        msgInput.addEventListener('focus', () => {
            if (currentRoom) socket.emit('msg_read', { roomId: currentRoom });
        });

        socket.on('receive_msg', (text) => {
            typingStatus.innerText = '';
            addMsg(text, 'partner');
            // å¦‚æœè¦–çª—æ˜¯é–‹å•Ÿçš„ï¼Œæ”¶åˆ°è¨Šæ¯ç«‹å³å›å‚³å·²è®€
            if (document.hasFocus()) {
                socket.emit('msg_read', { roomId: currentRoom });
            }
        });

        socket.on('partner_read', () => {
            const lastMyMsgStatus = chatBox.querySelector('.me-wrapper:last-child .read-status');
            if (lastMyMsgStatus) lastMyMsgStatus.innerText = 'å·²è®€';
        });

        socket.on('partner_typing', () => { typingStatus.innerText = 'æ€è€ƒè¦èªªä»€éº¼...'; });
        socket.on('partner_stop_typing', () => { typingStatus.innerText = ''; });

        socket.on('partner_left', () => {
            addSystemMsg('å°æ–¹å·²é›¢é–‹ã€‚');
            currentRoom = null;
            msgInput.disabled = true;
            mainBtn.innerText = 'é–‹å§‹';
        });

        function addMsg(text, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `msg-wrapper ${type === 'me' ? 'me-wrapper' : ''} ${type}`;
            
            let html = `<div class="msg ${type}">${text}</div>`;
            if (type === 'me') {
                html += `<div class="read-status"></div>`; // åˆå§‹é¡¯ç¤ºç‚ºç©ºï¼Œç­‰å¾… partner_read è§¸ç™¼
            }
            
            wrapper.innerHTML = html;
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
        }

        msgInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !msgInput.disabled) handleAction();
        });
    </script>
</body>
</html>