<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æš–æ¸¯é‡ HA TALK</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03QD2SY1QM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03QD2SY1QM');
    </script>

    <style>
        :root {
            --bg-color: #6a6461; --header-color: #8c8485;
            --my-msg: #4e6579; --partner-msg: #8c8485;
            --accent-color: #a08bab; --text-white: #ffffff;
            --sidebar-bg: #4a4542;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg-color); height: 100vh; display: flex; color: var(--text-white); overflow: hidden; }
        
        /* Sidebar & Overlay */
        #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: 0.3s ease; z-index: 2000; }
        .sidebar-header { padding: 25px 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-item { padding: 15px 20px; color: #ddd; text-decoration: none; display: block; cursor: pointer; }
        .menu-item.active { background: var(--accent-color); color: white; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500; }

        /* Main Area */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; transition: 0.3s; width: 100%; }
        header { background: var(--header-color); padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Topic Suggestion Style */
        .suggestion-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 10px 0; }
        .topic-btn { background: var(--accent-color); color: white; border: none; padding: 8px 15px; border-radius: 15px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .topic-btn:hover { opacity: 0.8; transform: scale(1.05); }

        #typing-status { font-size: 12px; color: #d1d1d1; padding: 5px 20px; height: 20px; font-style: italic; background: rgba(0,0,0,0.05); }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; }
        .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.partner { align-self: flex-start; }
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.me { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .msg.partner { background: var(--partner-msg); border-bottom-left-radius: 4px; }
        .read-status { font-size: 10px; color: #ccc; margin-top: 2px; height: 12px; }
        .system { align-self: center; font-size: 12px; color: #d1d1d1; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 12px; text-align: center; }

        /* End Button */
        #end-btn {
            background: rgba(220, 60, 60, 0.9);
            border: none;
            color: white;
            font-weight: bold;
            padding: 0 15px;
            margin-right: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }
        #end-btn:hover {
            background: rgba(200, 40, 40, 1);
        }

        #input-area { background: var(--header-color); padding: 12px; display: flex; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        input { flex: 1; border: none; background: rgba(255,255,255,0.15); padding: 12px 18px; border-radius: 25px; color: white; outline: none; font-size: 16px; }
        button#btn { background: var(--accent-color); border: none; color: white; font-weight: bold; padding: 0 20px; margin-left: 10px; border-radius: 25px; cursor: pointer; }
        button#btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: -260px; height: 100%; }
            #sidebar.open { left: 0; }
            #sidebar.open ~ #overlay { display: block; }
            #sidebar.open ~ #main-container { transform: translateX(260px); }
        }

        /* Disclaimer Modal */
        #disclaimer-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; color: #333; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">æš–æ¸¯é‡ HA TALK</div>
        <div class="menu-item active" onclick="closeSidebar()">ğŸ  å³æ™‚é…å°èŠå¤©</div>
        <a href="https://www.threads.net/@hatalk_canton" target="_blank" class="menu-item">ğŸ§µ Threads ç¤¾ç¾¤</a>
        <a href="https://www.instagram.com/hatalk_canton" target="_blank" class="menu-item">ğŸ“¸ æŠ•ç¨¿å°è©± (IG)</a>
    </div>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div id="main-container">
        <div id="disclaimer-modal">
            <div class="modal-content">
                <h3 style="color:var(--accent-color)">ä½¿ç”¨é ˆçŸ¥èˆ‡å…è²¬è²æ˜</h3>
                <p style="text-align:left; font-size:14px; color:#666;">1. åš´ç¦é¨·æ“¾ã€è©é¨™æˆ–éæ³•è¡Œç‚ºã€‚<br>2. ç³»çµ±ä¸å„²å­˜å°è©±ã€‚<br>3. é»æ“ŠåŒæ„å³ä»£è¡¨æ‚¨å·²æˆå¹´ã€‚</p>
                <button onclick="agreeDisclaimer()" style="background:var(--accent-color); color:white; border:none; padding:12px; border-radius:25px; width:100%; font-weight:bold; cursor:pointer;">æˆ‘åŒæ„ä¸¦é€²å…¥</button>
            </div>
        </div>

        <header>
            <span onclick="toggleSidebar(event)" style="cursor:pointer; padding:5px 15px; font-size:20px;">â˜°</span>
            æš–æ¸¯é‡ HA TALK
            <span style="width:50px;"></span>
        </header>
        
        <div id="chat-box"></div>
        <div id="typing-status"></div>
        
        <div id="input-area">
            <button id="end-btn" onclick="endChat()" style="display:none;">é›¢é–‹</button>
            <input id="msg" placeholder="æµåˆ°äººå…ˆå¯ä»¥å‚¾è¨ˆ..." disabled autocomplete="off">
            <button id="btn" onclick="handleAction()" disabled>é–‹å§‹</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        let typingTimeout = null;
        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const typingStatus = document.getElementById('typing-status');

        function toggleSidebar(e) { 
            e.stopPropagation(); 
            document.getElementById('sidebar').classList.toggle('open'); 
        }
        
        function closeSidebar() { 
            document.getElementById('sidebar').classList.remove('open'); 
        }

        function agreeDisclaimer() {
            document.getElementById('disclaimer-modal').style.display = 'none';
            if (socket.connected) startSearch();
            else socket.on('connect', startSearch);
        }

        function handleAction() {
            if (!currentRoom) startSearch();
            else sendMsg();
        }

        function startSearch() {
            socket.emit('start_chat');
            mainBtn.innerText = 'æµç·Šäºº';
            mainBtn.disabled = true;
            chatBox.innerHTML = ''; 
            removeEndChatButton();
            addSystemMsg('ç­‰é™£å“ˆï¼Œå¹«ä½ æµç·ŠäººåŒä½ å‚¾è¨ˆ...');
        }

        socket.on('waiting', (data) => {
            addSystemMsg(data.msg);
        });

        socket.on('queue_timeout', (data) => {
            addSystemMsg(`${data.msg}ï¼ˆç­‰å€™: ${data.waitingCount} äººï¼‰`);
        });

        socket.on('error', (data) => {
            addSystemMsg(`âš ï¸ ${data.msg}`);
            if (data.msg.includes('å·²ç¶“åœ¨èŠå¤©ä¸­')) {
                showEndChatButton();
            }
        });

        socket.on('matched', (data) => {
            currentRoom = data.roomId;
            chatBox.innerHTML = ''; 
            addSystemMsg('æµåˆ°äººå–‡ï¼é–‹å£å‚¾ä¸‹è¨ˆå•¦ ğŸ’¬');
            
            if (data.topics && data.topics.length > 0) {
                const container = document.createElement('div');
                container.className = 'suggestion-container';
                data.topics.forEach(t => {
                    const b = document.createElement('button');
                    b.className = 'topic-btn';
                    b.innerText = t;
                    b.onclick = () => {
                        msgInput.value = t;
                        msgInput.focus();
                        sendMsg();
                        container.remove();
                    };
                    container.appendChild(b);
                });
                chatBox.appendChild(container);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            showEndChatButton();

            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            msgInput.focus();
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
        });

        function sendMsg() {
            const text = msgInput.value.trim();
            if(!text || !currentRoom) return;
            
            if (text.length > 1000) {
                addSystemMsg('âš ï¸ è¨Šæ¯å¤ªé•·ï¼ˆæœ€å¤š1000å­—ï¼‰');
                return;
            }
            
            socket.emit('send_msg', { roomId: currentRoom, msg: text });
            addMsg(text, 'me');
            msgInput.value = '';
            socket.emit('stop_typing', { roomId: currentRoom });
        }

        msgInput.addEventListener('input', () => { 
            if (currentRoom) {
                socket.emit('typing', { roomId: currentRoom });
                
                if (typingTimeout) clearTimeout(typingTimeout);
                
                typingTimeout = setTimeout(() => {
                    socket.emit('stop_typing', { roomId: currentRoom });
                }, 2000);
            }
        });

        socket.on('receive_msg', (data) => {
            typingStatus.innerText = '';
            const text = typeof data === 'string' ? data : data.msg;
            addMsg(text, 'partner');
            socket.emit('msg_read', { roomId: currentRoom });
        });

        socket.on('partner_read', () => {
            const lastMyMsg = chatBox.querySelector('.me-wrapper:last-child .read-status');
            if (lastMyMsg) lastMyMsg.innerText = 'å·²è®€';
        });

        socket.on('partner_typing', () => { 
            typingStatus.innerText = 'å°æ–¹è«—ç·Šé»è¦†ä½ ...'; 
        });
        
        socket.on('partner_stop_typing', () => { 
            typingStatus.innerText = ''; 
        });

        socket.on('partner_left', (data) => {
            addSystemMsg(data.msg || 'å°æ–¹èµ°å’—å–‡ã€‚');
            resetToIdle();
        });

        socket.on('chat_ended', (data) => {
            addSystemMsg(data.msg || 'å°è©±å·²çµæŸ');
            resetToIdle();
        });

        function resetToIdle() {
            currentRoom = null;
            msgInput.disabled = true;
            msgInput.placeholder = "æµåˆ°äººå…ˆå¯ä»¥å‚¾è¨ˆ...";
            msgInput.value = '';
            mainBtn.innerText = 'é–‹å§‹';
            mainBtn.disabled = false;
            typingStatus.innerText = '';
            removeEndChatButton();
        }

        // âœ… ä¿®æ­£ï¼šæ“ä½œæ­£ç¢ºçš„æŒ‰éˆ•
        function showEndChatButton() {
            const endBtn = document.getElementById('end-btn');
            if (endBtn) endBtn.style.display = 'block';
        }

        function removeEndChatButton() {
            const endBtn = document.getElementById('end-btn');
            if (endBtn) endBtn.style.display = 'none';
        }

        function endChat() {
            if (!currentRoom) return;
            if (confirm('ç¢ºå®šè¦é›¢é–‹å°è©±ï¼Ÿ')) {
                socket.emit('end_chat');
                addSystemMsg('ä½ å·²é›¢é–‹å°è©±');
                resetToIdle();
            }
        }

        function addMsg(text, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `msg-wrapper ${type === 'me' ? 'me-wrapper' : ''} ${type}`;
            
            const safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            wrapper.innerHTML = `<div class="msg ${type}">${safeText}</div>` + 
                               (type === 'me' ? '<div class="read-status"></div>' : '');
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        msgInput.addEventListener("keypress", (e) => { 
            if (e.key === "Enter" && !msgInput.disabled) {
                handleAction(); 
            }
        });

        socket.on('disconnect', () => {
            addSystemMsg('âš ï¸ é€£ç·šä¸­æ–·ï¼Œå˜—è©¦é‡æ–°é€£ç·š...');
            mainBtn.disabled = true;
        });

        socket.on('connect', () => {
            if (currentRoom) {
                addSystemMsg('âœ… å·²é‡æ–°é€£ç·šï¼Œä½†å°è©±å·²ä¸­æ–·ï¼Œè«‹é‡æ–°é–‹å§‹');
                resetToIdle();
            }
        });
    </script>
</body>
</html>