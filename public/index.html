const socket = io({
    reconnection: true, 
    reconnectionAttempts: Infinity, // âœ… ç„¡é™é‡è©¦
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    timeout: 20000,
    transports: ['websocket', 'polling'] // âœ… æ”¯æ´é™ç´š
});

const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
const statusBar = document.getElementById('status-bar');

let originalTitle = document.title;
let flashInterval = null;

function startTitleFlash() {
    if (flashInterval) return;
    let isOriginal = true;
    flashInterval = setInterval(() => {
        document.title = isOriginal ? "ğŸ”” ä½ æœ‰æ–°è¨Šæ¯ï¼" : originalTitle;
        isOriginal = !isOriginal;
    }, 1000);
}

function stopTitleFlash() {
    if (flashInterval) {
        clearInterval(flashInterval);
        flashInterval = null;
        document.title = originalTitle;
    }
}

let currentRoom = null;
let typingTimeout = null;
let waitTimer = null; 

const chatBox = document.getElementById('chat-box');
const msgInput = document.getElementById('msg');
const mainBtn = document.getElementById('btn');
const typingStatus = document.getElementById('typing-status');

const waitContent = [
    { type: "æ€¥å£ä»¤", text: "å…¥å¯¦é©—å®¤ï¼Œæ’³ç·Šæ€¥æ£ã€‚" },
    { type: "æ€¥å£ä»¤", text: "éƒµå·®å”å”ï¼Œé€ä¿¡ç´”ç†Ÿï¼Œè¿…é€Ÿé€å‡ºã€‚" },
    { type: "æ€¥å£ä»¤", text: "ä¸€èšŠä¸€éš»é¾œ,ä¸ƒèšŠä¸€éš»é›ï¼Œä½ è©±é¾œè²´å®šé›è²´ï¼Ÿ" },
    { type: "æ€¥å£ä»¤", text: "ç—´ç·šèœ˜è››å•²èœ˜è››çµ²ï¼Œé»ä½ææ¨¹æã€‚" },
    { type: "æ€¥å£ä»¤", text: "éƒ­è—¹æ˜ééƒ­å¯ç›ˆï¼Œéƒ­å¯ç›ˆééƒ­è—¹æ˜ï¼Œéƒ­è—¹æ˜è©±éƒ­å¯ç›ˆééƒ­è—¹æ˜ã€‚" },
    { type: "çˆ›gag", text: "å¤§æ˜é¤Šå°æ˜ï¼Œå’é‚Šå€‹é¤Šå¤§æ˜ï¼Ÿ<br>... ç‹—ï¼ˆå› ç‚ºã€Œä¹…ã€ä»°å¤§æ˜ï¼‰" },
    { type: "çˆ›gag", text: "é»è§£å°æ˜è·‘å¾—å¿«éç«è»Šï¼Ÿ<br>... å› ç‚ºå°æ˜å–ºç«è»Šå…¥é¢è·‘ã€‚" },
    { type: "çˆ›gag", text: "å’©å‹•ç‰©æˆä¸–éƒ½å””æœƒé•·é«˜ï¼Ÿ<br>... é¾œï¼ˆå› ç‚ºã€Œé¾œè‹“è†ã€é›¶é«˜ï¼‰" },
    { type: "çˆ›gag", text: "å’©è±¬ä¿‚å¾— 1 éš»è…³ï¼Ÿ<br>... çå¯¶ã€Œç ã€" },
    { type: "çˆ›gag", text: "å’©ç²¥æœ€é¹¹æ¿•ï¼Ÿ<br>... åŠç¬¬ç²¥ï¼ˆå› ç‚ºã€Œğ¥„«åº•ã€ç²¥ï¼‰" },
    { type: "çˆ›gag", text: "å’©ç”Ÿæœæœ€å®¹æ˜“ç¨®ï¼Ÿ<br>... è•‰ï¼ˆå› ç‚ºã€Œä¸­æ‹›ã€ï¼‰" },
    { type: "çˆ›gag", text: "éš†èƒ¸å…©é‚Šéš†æ™’è¦ä¸€è¬ï¼Œä½†éš†ä¸€é‚Šåªè¦ä¸‰åƒï¼Œä¼°ä¸€æˆèªï¼Ÿ<br>... ä¸€ã€Œæ³¢ã€ä¸‰æŠ˜ã€‚" },
    { type: "çˆ›gag", text: "å’©å‹•ç‰©æœ€é¾æ„èåº•è¤²ï¼Ÿ<br>... è±¹ï¼ˆå› ç‚ºè±¹ã€Œç´‹ã€åº•è¤²ï¼‰" },
    { type: "çˆ›gag", text: "å»åˆ°æ³°åœ‹è¦é»æ¨£å«å˜¢é£Ÿï¼Ÿ<br>... æ‰“é–‹å€‹å˜´å«ã€‚" },
    { type: "çˆ›gag", text: "éµç›¤é‚Šå€‹æ£æœ€è²´ï¼Ÿ<br>... Space æ£ï¼ˆå› ç‚ºå€‹é¢ç©æœ€è²´ï¼‰ã€‚" },
    { type: "å†·çŸ¥è­˜", text: "åŸä¾†å»£æ±è©±æœ‰ 9 å€‹è²èª¿ï¼Œä½ è©¦ä¸‹æ•¸ï¼šã€è©©å²è©¦æ™‚å¸‚äº‹å…’ä¼¼å¯ºã€" },
    { type: "æŠ•ç¨¿", text: "æƒ³ä½ å˜…çˆ› Gag å‡ºç¾å–ºåº¦ï¼Ÿ<br>å» IG @hatalk_canton æŠ•ç¨¿å•¦ï¼" },
    { type: "æŠ•ç¨¿", text: "å°‹æ—¥æœ€æ­£å°è©±æˆªåœ–å·²ä¸Šå‚³ Threadsï¼Œå» bio ç‡å•¦ï¼" },
    { type: "æé†’", text: "åŒ¿åèŠå¤©é›–ç„¶å¥½ç©ï¼Œä½†è¨˜å¾—éƒ½è¦å°Šé‡å°æ–¹å–” â¤ï¸" },
    { type: "å°è²¼å£«", text: "è¬ä¸€å””çŸ¥å‚¾å’©å¥½ï¼Œå¯ä»¥ç”¨æˆ‘å“‹æä¾›å˜…ã€è©±é¡Œå»ºè­°ã€æ£ï¼" }
];

function toggleSidebar(e) { e.stopPropagation(); document.getElementById('sidebar').classList.toggle('open'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

function agreeDisclaimer() {
    document.getElementById('disclaimer-modal').style.display = 'none';
    if (socket.connected) {
        startSearch(); 
    } else {
        mainBtn.innerText = 'é€£ç·šä¸­...';
        socket.autoStart = true;
    }
}

function handleAction() {
    if (mainBtn.dataset.action === 'reload') {
        window.location.reload();
        return;
    }
    if (!currentRoom) startSearch();
    else sendMsg();
}

function startSearch() {
    socket.emit('start_chat');
    mainBtn.innerText = 'æµç·Šäºº';
    mainBtn.disabled = true;
    chatBox.innerHTML = ''; 
    removeEndChatButton();
    addSystemMsg('ç­‰é™£å“ˆï¼Œå¹«ä½ æµç·ŠäººåŒä½ å‚¾è¨ˆ...');

    const showJoke = () => {
        const item = waitContent[Math.floor(Math.random() * waitContent.length)];
        const oldJoke = document.querySelector('.joke-fade');
        if (oldJoke) oldJoke.remove();
        
        const jokeDiv = document.createElement('div');
        jokeDiv.className = 'joke-fade';
        jokeDiv.innerHTML = `<small>[${item.type}]</small><br>${item.text}`;
        chatBox.appendChild(jokeDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    showJoke();
    if (waitTimer) clearInterval(waitTimer);
    waitTimer = setInterval(showJoke, 5000); 
}

socket.on('matched', (data) => {
    if (waitTimer) clearInterval(waitTimer);
    currentRoom = data.roomId;
    chatBox.innerHTML = ''; 
    addSystemMsg('æµåˆ°äººå–‡ï¼é–‹å£å‚¾ä¸‹è¨ˆå•¦ ğŸ’¬');
    
    if (data.topics && data.topics.length > 0) {
        const container = document.createElement('div');
        container.className = 'suggestion-container';
        data.topics.forEach(topic => {
            const btn = document.createElement('button');
            btn.className = 'topic-btn';
            btn.innerText = topic;
            btn.addEventListener('click', function() {
                msgInput.value = topic;
                msgInput.focus();
                sendMsg();
                container.remove();
            });
            container.appendChild(btn);
        });
        chatBox.appendChild(container);
    }

    showEndChatButton();
    msgInput.disabled = false;
    msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
    msgInput.focus();
    mainBtn.innerText = 'å‚³é€';
    mainBtn.disabled = false;
    setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 300);
});

function sendMsg() {
    const text = msgInput.value.trim();
    if(!text || !currentRoom) return;
    if (text.length > 1000) { addSystemMsg('âš ï¸ è¨Šæ¯å¤ªé•·'); return; }
    socket.emit('send_msg', { roomId: currentRoom, msg: text });
    addMsg(text, 'me');
    msgInput.value = '';
    socket.emit('stop_typing', { roomId: currentRoom });
}

msgInput.addEventListener('input', () => { 
    if (currentRoom) {
        socket.emit('typing', { roomId: currentRoom });
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => { socket.emit('stop_typing', { roomId: currentRoom }); }, 2000);
    }
});

socket.on('receive_msg', (data) => {
    typingStatus.innerText = '';
    const text = typeof data === 'string' ? data : data.msg;
    addMsg(text, 'partner');
    socket.emit('msg_read', { roomId: currentRoom });
    
    if (document.hidden) {
        notificationSound.play().catch(e => console.log('ç€è¦½å™¨é˜»æ“‹è‡ªå‹•æ’­æ”¾'));
        startTitleFlash();
    }
});

socket.on('partner_read', () => {
    const lastMyMsg = chatBox.querySelector('.me-wrapper:last-child .read-status');
    if (lastMyMsg) lastMyMsg.innerText = 'å·²è®€';
});

socket.on('partner_typing', () => { typingStatus.innerText = 'å°æ–¹è«—ç·Šé»è¦†ä½ ...'; });
socket.on('partner_stop_typing', () => { typingStatus.innerText = ''; });

socket.on('partner_status', (data) => {
    typingStatus.innerText = data.msg;
});

// âœ… æ–°å¢ï¼šè™•ç†é€£ç·šæ¢å¾©
socket.on('connection_recovered', (data) => {
    statusBar.style.display = 'none';
    currentRoom = data.roomId;
    addSystemMsg('âœ… é€£ç·šå·²æ¢å¾©');
    typingStatus.innerText = '';
});

// âœ… çµ±ä¸€è™•ç†æ‰€æœ‰é›¢é–‹å ´æ™¯ï¼Œéƒ½é¡¯ç¤ºé‡æ–°é…å°æŒ‰éˆ•
socket.on('partner_left', (data) => {
    if (waitTimer) clearInterval(waitTimer);
    addSystemMsg(data.msg || 'å°æ–¹èµ°å’—å–‡ã€‚');
    showRematchButton();
    resetToIdle();
});

socket.on('chat_ended', (data) => {
    addSystemMsg(data.msg || 'å°è©±å·²çµæŸ');
    showRematchButton();
    resetToIdle();
});

// âœ… æ–°å¢çµ±ä¸€çš„é‡æ–°é…å°æŒ‰éˆ•å‡½æ•¸
function showRematchButton() {
    // ç§»é™¤èˆŠçš„æŒ‰éˆ•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const oldBtn = document.querySelector('.rematch-button-container');
    if (oldBtn) oldBtn.remove();
    
    const btnDiv = document.createElement('div');
    btnDiv.className = 'rematch-button-container';
    btnDiv.style.textAlign = 'center';
    btnDiv.style.margin = '20px 0';
    btnDiv.innerHTML = `<button onclick="startSearch()" style="background:var(--accent-color); color:white; border:none; padding:14px 28px; border-radius:25px; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.2); font-size:15px; cursor:pointer;">ğŸ”„ å°‹æ‰¾ä¸‹ä¸€å€‹</button>`;
    chatBox.appendChild(btnDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function resetToIdle() {
    currentRoom = null;
    msgInput.disabled = true;
    msgInput.placeholder = "æµåˆ°äººå…ˆå¯ä»¥å‚¾è¨ˆ...";
    msgInput.value = '';
    mainBtn.innerText = 'é–‹å§‹';
    mainBtn.disabled = false;
    mainBtn.dataset.action = ''; 
    typingStatus.innerText = '';
    removeEndChatButton();
}

function showEndChatButton() { document.getElementById('end-btn').style.display = 'block'; }
function removeEndChatButton() { document.getElementById('end-btn').style.display = 'none'; }

function endChat() {
    if (!currentRoom) return;
    if (confirm('çœŸä¿‚è¦é›¢é–‹ï¼Ÿå°æ–¹æœƒå¥½å‚·å¿ƒã—å– ğŸ¥º')) {
        socket.emit('end_chat');
        addSystemMsg('ä½ å·²é›¢é–‹å°è©±');
        showRematchButton(); // âœ… ä¸»å‹•é›¢é–‹ä¹Ÿé¡¯ç¤ºé‡æ–°é…å°æŒ‰éˆ•
        resetToIdle();
    }
}

function addMsg(text, type) {
    const wrapper = document.createElement('div');
    wrapper.className = `msg-wrapper ${type === 'me' ? 'me-wrapper' : ''} ${type}`;
    const safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    wrapper.innerHTML = `<div class="msg ${type}">${safeText}</div>` + (type === 'me' ? '<div class="read-status"></div>' : '');
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function addSystemMsg(text) {
    const div = document.createElement('div');
    div.className = 'system';
    div.innerText = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter" && !msgInput.disabled) handleAction(); });

// âœ… æ”¹é€²æ–·ç·šè™•ç†
socket.on('disconnect', (reason) => {
    if (waitTimer) clearInterval(waitTimer);
    
    // æ‰€æœ‰æ–·ç·šæƒ…æ³éƒ½é¡¯ç¤ºç‹€æ…‹æ¢ï¼Œä½†ä¸ç ´å£ UI
    statusBar.style.display = 'block';
    console.log('Disconnected:', reason);
    
    // ä¸å†é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œè®“ Socket.io è‡ªå‹•é‡é€£
});

socket.on('connect', () => {
    statusBar.style.display = 'none';
    console.log('Connected');

    if (socket.autoStart) {
        startSearch();
        delete socket.autoStart; 
    } 
    else if (mainBtn.dataset.action === 'reload') {
        addSystemMsg('âœ… ç¶²çµ¡å·²æ¢å¾©');
        resetToIdle();
    } else if (mainBtn.disabled && mainBtn.innerText === 'é€£ç·šä¸­...') {
        mainBtn.innerText = 'é–‹å§‹';
        mainBtn.disabled = false;
    }
});

// âœ… å¢å¼·æ‰‹æ©ŸèƒŒæ™¯æ¢å¾©
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        stopTitleFlash(); 
        // å›åˆ°å‰æ™¯æ™‚ï¼Œå¦‚æœæ–·ç·šå°±å˜—è©¦é‡é€£
        if (!socket.connected) {
            statusBar.style.display = 'block';
            socket.connect();
        }
    }
});

// âœ… æ–°å¢ï¼šç›£è½ç¶²çµ¡ç‹€æ…‹è®ŠåŒ–
window.addEventListener('online', () => {
    console.log('Network online');
    if (!socket.connected) {
        statusBar.style.display = 'block';
        socket.connect();
    }
});

window.addEventListener('offline', () => {
    console.log('Network offline');
    statusBar.style.display = 'block';
    statusBar.textContent = 'âš ï¸ ç¶²çµ¡å·²æ–·ç·š';
});