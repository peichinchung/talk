<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æš–æ¸¯é‡ HA TALK</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03QD2SY1QM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03QD2SY1QM');
    </script>

    <style>
        :root {
            --bg-color: #6a6461; --header-color: #8c8485;
            --my-msg: #4e6579; --partner-msg: #8c8485;
            --accent-color: #a08bab; --text-white: #ffffff;
            --sidebar-bg: #4a4542;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg-color); height: 100vh; display: flex; color: var(--text-white); overflow: hidden; }
        
        #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: 0.3s ease; z-index: 2000; }
        .sidebar-header { padding: 25px 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-item { padding: 15px 20px; color: #ddd; text-decoration: none; display: block; cursor: pointer; }
        .menu-item.active { background: var(--accent-color); color: white; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500; }

        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; transition: 0.3s; width: 100%; }
        header { background: var(--header-color); padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        /* ğŸ’¡ æ–°å¢ï¼šç¬‘è©±å¡ç‰‡æ¨£å¼ */
        .joke-fade {
            animation: fadeIn 0.8s ease-in-out;
            background: rgba(160, 139, 171, 0.15) !important;
            border-left: 4px solid var(--accent-color);
            border-radius: 8px;
            padding: 12px 16px !important;
            max-width: 85%;
            margin: 15px auto !important;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            text-align: left;
            line-height: 1.6;
        }
        .joke-fade small { color: var(--accent-color); font-weight: bold; font-size: 11px; }

        .suggestion-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 10px 0; }
        .topic-btn { background: var(--accent-color); color: white; border: none; padding: 10px 16px; border-radius: 15px; font-size: 14px; cursor: pointer; transition: 0.2s; -webkit-tap-highlight-color: transparent; user-select: none; }
        .topic-btn:active { opacity: 0.7; transform: scale(0.95); }

        #typing-status { font-size: 12px; color: #d1d1d1; padding: 5px 20px; height: 20px; font-style: italic; background: rgba(0,0,0,0.05); }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; }
        .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.partner { align-self: flex-start; }
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.me { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .msg.partner { background: var(--partner-msg); border-bottom-left-radius: 4px; }
        .read-status { font-size: 10px; color: #ccc; margin-top: 2px; height: 12px; }
        .system { align-self: center; font-size: 12px; color: #d1d1d1; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 12px; text-align: center; }

        #end-btn { background: rgba(220, 60, 60, 0.9); border: none; color: white; font-weight: bold; padding: 0 16px; margin-right: 8px; border-radius: 25px; cursor: pointer; font-size: 14px; transition: 0.2s; flex-shrink: 0; min-width: 50px; }
        #end-btn:active { background: rgba(200, 40, 40, 1); transform: scale(0.95); }

        #input-area { background: var(--header-color); padding: 10px; display: flex; gap: 8px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        input { flex: 1; border: none; background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 25px; color: white; outline: none; font-size: 16px; min-width: 0; }
        button#btn { background: var(--accent-color); border: none; color: white; font-weight: bold; padding: 0 20px; border-radius: 25px; cursor: pointer; flex-shrink: 0; min-width: 60px; }
        button#btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: -260px; height: 100%; }
            #sidebar.open { left: 0; }
            #sidebar.open ~ #overlay { display: block; }
            #sidebar.open ~ #main-container { transform: translateX(260px); }
            .topic-btn { padding: 12px 18px; font-size: 15px; min-height: 44px; }
        }
        #disclaimer-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; color: #333; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">æš–æ¸¯é‡ HA TALK</div>
        <div class="menu-item active" onclick="closeSidebar()">ğŸ  å³æ™‚é…å°èŠå¤©</div>
        <a href="https://www.threads.net/@hatalk_canton" target="_blank" class="menu-item">ğŸ§µ Threads ç¤¾ç¾¤</a>
        <a href="https://www.instagram.com/hatalk_canton" target="_blank" class="menu-item">ğŸ“¸ æŠ•ç¨¿å°è©± (IG)</a>
    </div>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div id="main-container">
        <div id="disclaimer-modal">
            <div class="modal-content">
                <h3 style="color:var(--accent-color)">ä½¿ç”¨é ˆçŸ¥èˆ‡å…è²¬è²æ˜</h3>
                <p style="text-align:left; font-size:14px; color:#666;">1. åš´ç¦é¨·æ“¾ã€è©é¨™æˆ–éæ³•è¡Œç‚ºã€‚<br>2. ç³»çµ±ä¸å„²å­˜å°è©±ã€‚<br>3. é»æ“ŠåŒæ„å³ä»£è¡¨æ‚¨å·²æˆå¹´ã€‚</p>
                <button onclick="agreeDisclaimer()" style="background:var(--accent-color); color:white; border:none; padding:12px; border-radius:25px; width:100%; font-weight:bold; cursor:pointer;">æˆ‘åŒæ„ä¸¦é€²å…¥</button>
            </div>
        </div>

        <header>
            <span onclick="toggleSidebar(event)" style="cursor:pointer; padding:5px 15px; font-size:20px;">â˜°</span>
            æš–æ¸¯é‡ HA TALK
            <span style="width:50px;"></span>
        </header>
        
        <div id="chat-box"></div>
        <div id="typing-status"></div>
        
        <div id="input-area">
            <button id="end-btn" onclick="endChat()" style="display:none;">é›¢é–‹</button>
            <input id="msg" placeholder="æµåˆ°äººå…ˆå¯ä»¥å‚¾è¨ˆ..." disabled autocomplete="off">
            <button id="btn" onclick="handleAction()" disabled>é–‹å§‹</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        let typingTimeout = null;
        let waitTimer = null; // âœ… è¼ªæ’­è¨ˆæ™‚å™¨

        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const typingStatus = document.getElementById('typing-status');
// âœ… ä¿®æ­£èªæ³•å¾Œçš„ç¬‘è©±å…§å®¹åº«
const waitContent = [
    { type: "æ€¥å£ä»¤", text: "å…¥å¯¦é©—å®¤ï¼Œæ’³ç·Šæ€¥æ£ã€‚" },
    { type: "æ€¥å£ä»¤", text: "éƒµå·®å”å”ï¼Œé€ä¿¡ç´”ç†Ÿï¼Œè¿…é€Ÿé€å‡ºã€‚" },
    { type: "æ€¥å£ä»¤", text: "ä¸€èšŠä¸€éš»é¾œï¼Œä¸ƒèšŠä¸€éš»é›ï¼Œä½ è©±é¾œè²´å®šé›è²´ï¼Ÿ" },
    { type: "æ€¥å£ä»¤", text: "ç—´ç·šèœ˜è››å•²èœ˜è››çµ²ï¼Œé»ä½ææ¨¹æã€‚" },
    { type: "æ€¥å£ä»¤", text: "éƒ­è—¹æ˜ééƒ­å¯ç›ˆï¼Œéƒ­å¯ç›ˆééƒ­è—¹æ˜ï¼Œéƒ­è—¹æ˜è©±éƒ­å¯ç›ˆééƒ­è—¹æ˜ã€‚" },
    { type: "çˆ›gag", text: "å¤§æ˜é¤Šå°æ˜ï¼Œå’é‚Šå€‹é¤Šå¤§æ˜ï¼Ÿ<br>... ç‹—ï¼ˆå› ç‚ºã€Œä¹…ã€ä»°å¤§æ˜ï¼‰" },
    { type: "çˆ›gag", text: "é»è§£å°æ˜è·‘å¾—å¿«éç«è»Šï¼Ÿ<br>... å› ç‚ºå°æ˜å–ºç«è»Šå…¥é¢è·‘ã€‚" },
    { type: "çˆ›gag", text: "å’©å‹•ç‰©æˆä¸–éƒ½å””æœƒé•·é«˜ï¼Ÿ<br>... é¾œï¼ˆå› ç‚ºã€Œé¾œè‹“è†ã€é›¶é«˜ï¼‰" },
    { type: "çˆ›gag", text: "å’©è±¬ä¿‚å¾— 1 éš»è…³ï¼Ÿ<br>... çå¯¶ã€Œç ã€" },
    { type: "çˆ›gag", text: "å’©ç²¥æœ€é¹¹æ¿•ï¼Ÿ<br>... åŠç¬¬ç²¥ï¼ˆå› ç‚ºã€Œğ¥„«åº•ã€ç²¥ï¼‰" },
    { type: "çˆ›gag", text: "å’©ç”Ÿæœæœ€å®¹æ˜“ç¨®ï¼Ÿ<br>... è•‰ï¼ˆå› ç‚ºã€Œä¸­æ‹›ã€ï¼‰" },
    { type: "çˆ›gag", text: "éš†èƒ¸å…©é‚Šéš†æ™’è¦ä¸€è¬ï¼Œä½†éš†ä¸€é‚Šåªè¦ä¸‰åƒï¼Œä¼°ä¸€æˆèªï¼Ÿ<br>... ä¸€ã€Œæ³¢ã€ä¸‰æŠ˜ã€‚" },
    { type: "çˆ›gag", text: "å’©å‹•ç‰©æœ€é¾æ„èåº•è¤²ï¼Ÿ<br>... è±¹ï¼ˆå› ç‚ºè±¹ã€Œç´‹ã€åº•è¤²ï¼‰" },
    { type: "çˆ›gag", text: "å»åˆ°æ³°åœ‹è¦é»æ¨£å«å˜¢é£Ÿï¼Ÿ<br>... æ‰“é–‹å€‹å˜´å«ã€‚" },
    { type: "çˆ›gag", text: "éµç›¤é‚Šå€‹æ£æœ€è²´ï¼Ÿ<br>... Space æ£ï¼ˆå› ç‚ºå€‹é¢ç©æœ€è²´ï¼‰ã€‚" },
    { type: "å†·çŸ¥è­˜", text: "åŸä¾†å»£æ±è©±æœ‰ 9 å€‹è²èª¿ï¼Œä½ è©¦ä¸‹æ•¸ï¼šã€è©©å²è©¦æ™‚å¸‚äº‹å…’ä¼¼å¯ºã€" },
    { type: "æŠ•ç¨¿", text: "æƒ³ä½ å˜…çˆ› Gag å‡ºç¾å–ºåº¦ï¼Ÿ<br>å» IG @hatalk_canton æŠ•ç¨¿å•¦ï¼" },
    { type: "æŠ•ç¨¿", text: "å°‹æ—¥æœ€æ­£å°è©±æˆªåœ–å·²ä¸Šå‚³ Threadsï¼Œå» bio ç‡å•¦ï¼" },
    { type: "æé†’", text: "åŒ¿åèŠå¤©é›–ç„¶å¥½ç©ï¼Œä½†è¨˜å¾—éƒ½è¦å°Šé‡å°æ–¹å–” â¤ï¸" },
    { type: "å°è²¼å£«", text: "è¬ä¸€å””çŸ¥å‚¾å’©å¥½ï¼Œå¯ä»¥ç”¨æˆ‘å“‹æä¾›å˜…ã€è©±é¡Œå»ºè­°ã€æ£ï¼" }
];

        function toggleSidebar(e) { e.stopPropagation(); document.getElementById('sidebar').classList.toggle('open'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

        function agreeDisclaimer() {
            document.getElementById('disclaimer-modal').style.display = 'none';
            if (socket.connected) startSearch();
            else socket.on('connect', startSearch);
        }

        function handleAction() {
            if (!currentRoom) startSearch();
            else sendMsg();
        }

        // âœ… ä¿®æ­£ï¼šå•Ÿå‹•æœå°‹ä¸¦é–‹å•Ÿç¬‘è©±è¼ªæ’­
        function startSearch() {
            socket.emit('start_chat');
            mainBtn.innerText = 'æµç·Šäºº';
            mainBtn.disabled = true;
            chatBox.innerHTML = ''; 
            removeEndChatButton();
            addSystemMsg('ç­‰é™£å“ˆï¼Œå¹«ä½ æµç·ŠäººåŒä½ å‚¾è¨ˆ...');

            // å•Ÿå‹•ç¬‘è©±è¼ªæ’­
            const showJoke = () => {
                const item = waitContent[Math.floor(Math.random() * waitContent.length)];
                const oldJoke = document.querySelector('.joke-fade');
                if (oldJoke) oldJoke.remove();
                
                const jokeDiv = document.createElement('div');
                jokeDiv.className = 'joke-fade';
                jokeDiv.innerHTML = `<small>[${item.type}]</small><br>${item.text}`;
                chatBox.appendChild(jokeDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            };

            showJoke();
            if (waitTimer) clearInterval(waitTimer);
            waitTimer = setInterval(showJoke, 5000); // æ¯ 5 ç§’æ›ä¸€å€‹
        }

        socket.on('matched', (data) => {
            if (waitTimer) clearInterval(waitTimer); // âœ… åœæ­¢ç¬‘è©±
            currentRoom = data.roomId;
            chatBox.innerHTML = ''; 
            addSystemMsg('æµåˆ°äººå–‡ï¼é–‹å£å‚¾ä¸‹è¨ˆå•¦ ğŸ’¬');
            
            if (data.topics && data.topics.length > 0) {
                const container = document.createElement('div');
                container.className = 'suggestion-container';
                data.topics.forEach(topic => {
                    const btn = document.createElement('button');
                    btn.className = 'topic-btn';
                    btn.innerText = topic;
                    btn.addEventListener('click', function() {
                        msgInput.value = topic;
                        msgInput.focus();
                        sendMsg();
                        container.remove();
                    });
                    container.appendChild(btn);
                });
                chatBox.appendChild(container);
            }

            showEndChatButton();
            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            msgInput.focus();
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
            setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 100);
        });

        function sendMsg() {
            const text = msgInput.value.trim();
            if(!text || !currentRoom) return;
            if (text.length > 1000) { addSystemMsg('âš ï¸ è¨Šæ¯å¤ªé•·'); return; }
            socket.emit('send_msg', { roomId: currentRoom, msg: text });
            addMsg(text, 'me');
            msgInput.value = '';
            socket.emit('stop_typing', { roomId: currentRoom });
        }

        msgInput.addEventListener('input', () => { 
            if (currentRoom) {
                socket.emit('typing', { roomId: currentRoom });
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => { socket.emit('stop_typing', { roomId: currentRoom }); }, 2000);
            }
        });

        socket.on('receive_msg', (data) => {
            typingStatus.innerText = '';
            const text = typeof data === 'string' ? data : data.msg;
            addMsg(text, 'partner');
            socket.emit('msg_read', { roomId: currentRoom });
        });

        socket.on('partner_read', () => {
            const lastMyMsg = chatBox.querySelector('.me-wrapper:last-child .read-status');
            if (lastMyMsg) lastMyMsg.innerText = 'å·²è®€';
        });

        socket.on('partner_typing', () => { typingStatus.innerText = 'å°æ–¹è«—ç·Šé»è¦†ä½ ...'; });
        socket.on('partner_stop_typing', () => { typingStatus.innerText = ''; });

        socket.on('partner_left', (data) => {
            if (waitTimer) clearInterval(waitTimer);
            addSystemMsg(data.msg || 'å°æ–¹èµ°å’—å–‡ã€‚');
            resetToIdle();
        });

        function resetToIdle() {
            currentRoom = null;
            msgInput.disabled = true;
            msgInput.placeholder = "æµåˆ°äººå…ˆå¯ä»¥å‚¾è¨ˆ...";
            msgInput.value = '';
            mainBtn.innerText = 'é–‹å§‹';
            mainBtn.disabled = false;
            typingStatus.innerText = '';
            removeEndChatButton();
        }

        function showEndChatButton() { document.getElementById('end-btn').style.display = 'block'; }
        function removeEndChatButton() { document.getElementById('end-btn').style.display = 'none'; }

        function endChat() {
            if (!currentRoom) return;
            if (confirm('çœŸä¿‚è¦é›¢é–‹ï¼Ÿå°æ–¹æœƒå¥½å‚·å¿ƒã—å– ğŸ¥º')) {
                socket.emit('end_chat');
                addSystemMsg('ä½ å·²é›¢é–‹å°è©±');
                resetToIdle();
            }
        }

        function addMsg(text, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `msg-wrapper ${type === 'me' ? 'me-wrapper' : ''} ${type}`;
            const safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            wrapper.innerHTML = `<div class="msg ${type}">${safeText}</div>` + (type === 'me' ? '<div class="read-status"></div>' : '');
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter" && !msgInput.disabled) handleAction(); });

        socket.on('disconnect', () => {
            if (waitTimer) clearInterval(waitTimer);
            addSystemMsg('âš ï¸ é€£ç·šä¸­æ–·');
            mainBtn.disabled = true;
        });
    </script>
</body>
</html>