<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æš–æ¸¯é‡ HA TALK - åŒ¿åé…å°èŠå¤©</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03QD2SY1QM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03QD2SY1QM');
    </script>

    <style>
        :root {
            --bg-color: #6a6461; --header-color: #8c8485;
            --my-msg: #4e6579; --partner-msg: #8c8485;
            --accent-color: #a08bab; --text-white: #ffffff;
            --sidebar-bg: #4a4542;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; background: var(--bg-color); 
            height: 100vh; height: 100dvh; 
            display: flex; color: var(--text-white); 
            overflow: hidden; overscroll-behavior: none; 
        }
        
        #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: 0.3s ease; z-index: 2000; position: absolute; left: -260px; height: 100%; }
        #sidebar.open { left: 0; }
        .menu-item { padding: 15px 20px; color: #ddd; text-decoration: none; display: block; cursor: pointer; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500; }
        #sidebar.open ~ #overlay { display: block; }

        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }
        header { background: var(--header-color); padding: 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; flex-shrink: 0; }
        
        #status-bar { display: none; background: #ff4d4d; color: white; font-size: 12px; text-align: center; padding: 6px; font-weight: bold; }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
        
        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; position: relative; margin-bottom: 4px; }
        .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.partner { align-self: flex-start; }
        
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.me { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .msg.partner { background: var(--partner-msg); border-bottom-left-radius: 4px; }

        .read-status { font-size: 10px; color: rgba(255,255,255,0.6); margin-top: 2px; margin-right: 4px; height: 14px; opacity: 0; transition: opacity 0.3s; }
        .read-status.active { opacity: 1; }

        .typing-bubble {
            align-self: flex-start; background: var(--partner-msg); padding: 10px 16px;
            border-radius: 20px; border-bottom-left-radius: 4px; width: fit-content;
            display: none; align-items: center; gap: 4px; margin-bottom: 10px;
        }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.7); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .rematch-container { text-align: center; margin: 30px 0; animation: fadeIn 0.5s forwards; }
        .rematch-btn {
            background: var(--accent-color); color: white; border: none; padding: 12px 28px;
            border-radius: 30px; font-weight: bold; font-size: 15px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .system { align-self: center; font-size: 12px; color: #d1d1d1; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 12px; text-align: center; margin: 5px 0; }

        #input-area { background: var(--header-color); padding: 10px; display: flex; gap: 8px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        input { flex: 1; border: none; background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 25px; color: white; outline: none; font-size: 16px; }
        button#btn { background: var(--accent-color); border: none; color: white; font-weight: bold; padding: 0 20px; border-radius: 25px; cursor: pointer; min-width: 60px; }
        button#btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #end-btn { background: rgba(220, 60, 60, 0.9); border: none; color: white; font-weight: bold; padding: 0 16px; margin-right: 8px; border-radius: 25px; cursor: pointer; display: none; }
        
        #typing-text-status { font-size: 12px; color: #d1d1d1; padding: 0 20px; height: 20px; font-style: italic; position: absolute; bottom: 70px; left: 0; width: 100%; pointer-events: none; }

        .suggestion-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 10px 0; }
        .topic-btn { background: var(--accent-color); color: white; border: none; padding: 8px 12px; border-radius: 15px; font-size: 13px; cursor: pointer; }

        #disclaimer-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); }
        .modal-content { background: white; color: #333; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; }
        .modal-btn { background: var(--accent-color); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; width: 100%; }
        
        .joke-fade { animation: fadeIn 0.8s ease-in-out; background: rgba(160, 139, 171, 0.2) !important; border-left: 4px solid var(--accent-color); padding: 15px !important; margin: 10px 0 !important; font-size: 14px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="disclaimer-modal">
        <div class="modal-content">
            <h2 style="color:var(--accent-color); margin-top:0;">ğŸ‘‹ æ­¡è¿ä¾†åˆ°æš–æ¸¯é‡</h2>
            <div style="text-align:left; font-size:14px; color:#666; line-height:1.6; margin: 20px 0;">
                <p>1. é€™è£¡æ˜¯ä¸€å€‹åŒ¿åé…å°èŠå¤©ç©ºé–“ã€‚</p>
                <p>2. åš´ç¦é¨·æ“¾ã€è©é¨™ã€å»£å‘Šæˆ–éæ³•è¡Œç‚ºã€‚</p>
                <p>3. ç³»çµ±ä¸å„²å­˜å°è©±ï¼Œé›¢é–‹å³ç„šã€‚</p>
                <p>4. é»æ“ŠæŒ‰éˆ•å³ä»£è¡¨æ‚¨å·²æˆå¹´ä¸¦åŒæ„è¦å‰‡ã€‚</p>
            </div>
            <button class="modal-btn" onclick="agreeDisclaimer()">æˆ‘åŒæ„ä¸¦é–‹å§‹é…å°</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="menu-item" style="border-bottom:1px solid #666; font-weight:bold;">æš–æ¸¯é‡ HA TALK</div>
        <div class="menu-item" onclick="closeSidebar()">ğŸ  å³æ™‚é…å°èŠå¤©</div>
        <a href="https://www.instagram.com/hatalk_canton" target="_blank" class="menu-item">ğŸ“¸ Instagram</a>
    </div>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div id="main-container">
        <header>
            <span onclick="toggleSidebar(event)" style="cursor:pointer; padding:5px 15px; font-size:20px;">â˜°</span>
            æš–æ¸¯é‡ HA TALK
            <span style="width:50px;"></span>
        </header>

        <div id="status-bar">âš ï¸ ç¶²çµ¡é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</div>
        
        <div id="chat-box"></div>
        
        <div id="typing-bubble-container" class="typing-bubble">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>

        <div id="typing-text-status"></div>
        
        <div id="input-area">
            <button id="end-btn" onclick="endChat()">é›¢é–‹</button>
            <input id="msg" placeholder="è«‹å…ˆå®Œæˆå…è²¬åŒæ„..." disabled autocomplete="off">
            <button id="btn" onclick="handleAction()" disabled>é–‹å§‹</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // 1. èº«ä»½è­˜åˆ¥èˆ‡ Token (ç¢ºä¿æ¸¬è©¦æ™‚ä¸åŒç”¨æˆ¶)
        // ä½¿ç”¨ sessionStorage ç¢ºä¿æ¯æ¬¡é–‹æ–°åˆ†é éƒ½æ˜¯ç¨ç«‹ç”¨æˆ¶ï¼Œæˆ– localStorage ä¿æŒåŒä¸€äºº
        let myUserId = localStorage.getItem('ha_talk_uid');
        if (!myUserId) {
            myUserId = 'u_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('ha_talk_uid', myUserId);
        }

        // 2. åˆå§‹åŒ– Socket
        const socket = io({
            auth: { token: myUserId },
            reconnection: true,
            timeout: 10000
        });

        // ä»‹é¢å…ƒç´ 
        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg');
        const mainBtn = document.getElementById('btn');
        const statusBar = document.getElementById('status-bar');
        const typingTextStatus = document.getElementById('typing-text-status');
        const endBtn = document.getElementById('end-btn');
        const typingBubble = document.getElementById('typing-bubble-container');

        let currentRoom = null;
        let waitTimer = null;
        let isSearching = false;

        const waitContent = [
            { type: "çˆ›gag", text: "é»è§£å°æ˜è·‘å¾—å¿«éç«è»Šï¼Ÿ<br>... å› ç‚ºå°æ˜å–ºç«è»Šå…¥é¢è·‘ã€‚" },
            { type: "æé†’", text: "åŒ¿åèŠå¤©é›–ç„¶å¥½ç©ï¼Œä½†è¨˜å¾—éƒ½è¦å°Šé‡å°æ–¹å–” â¤ï¸" },
            { type: "å†·çŸ¥è­˜", text: "åŸä¾†å»£æ±è©±æœ‰ 9 å€‹è²èª¿ï¼Œä½ è©¦ä¸‹æ•¸ï¼šã€è©©å²è©¦æ™‚å¸‚äº‹å…’ä¼¼å¯ºã€" }
        ];

        // 3. æŒ‰ä¸‹åŒæ„æŒ‰éˆ•
        function agreeDisclaimer() {
            document.getElementById('disclaimer-modal').style.display = 'none';
            msgInput.placeholder = "ç­‰å¾…é–‹å§‹...";
            if (socket.connected) {
                startSearch(); 
            } else {
                mainBtn.innerText = 'é€£ç·šä¸­...';
                socket.autoStartSearch = true; // æ¨™è¨˜ï¼šé€£ä¸Šå¾Œè‡ªå‹•é–‹å§‹
            }
        }

        function handleAction() {
            if (!currentRoom && !isSearching) startSearch();
            else if (currentRoom) sendMsg();
        }

        function startSearch() {
            if (isSearching) return;
            isSearching = true;
            currentRoom = null;
            
            chatBox.innerHTML = '';
            addSystemMsg('æ­£åœ¨ç‚ºä½ æœå°‹å°è±¡...');
            
            socket.emit('start_chat');
            
            mainBtn.innerText = 'æœå°‹ä¸­';
            mainBtn.disabled = true;
            msgInput.disabled = true;
            endBtn.style.display = 'none';

            // é¡¯ç¤ºè¶£å‘³å…§å®¹
            const showJoke = () => {
                const item = waitContent[Math.floor(Math.random() * waitContent.length)];
                const jokeDiv = document.createElement('div');
                jokeDiv.className = 'joke-fade';
                jokeDiv.innerHTML = `<small style="color:var(--accent-color);">[${item.type}]</small><br>${item.text}`;
                chatBox.appendChild(jokeDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            };
            showJoke();
            waitTimer = setInterval(showJoke, 6000);
        }

        function sendMsg() {
            const text = msgInput.value.trim();
            if (!text || !currentRoom) return;

            socket.emit('send_msg', { msg: text }, (response) => {
                if (response && response.status === 'ok') {
                    addMsg(text, 'me');
                    msgInput.value = '';
                    socket.emit('stop_typing');
                }
            });
        }

        function endChat() {
            if (confirm('ç¢ºå®šè¦çµæŸé€™æ¬¡å°è©±å—ï¼Ÿ')) {
                socket.emit('end_chat');
                resetToIdle();
                addSystemMsg('ä½ å·²çµæŸå°è©±');
                showRematchButton();
            }
        }

        function resetToIdle() {
            currentRoom = null;
            isSearching = false;
            if (waitTimer) clearInterval(waitTimer);
            msgInput.disabled = true;
            msgInput.value = '';
            msgInput.placeholder = "å°è©±å·²çµæŸ";
            mainBtn.innerText = 'é–‹å§‹';
            mainBtn.disabled = false;
            endBtn.style.display = 'none';
            typingBubble.style.display = 'none';
        }

        function showRematchButton() {
            const div = document.createElement('div');
            div.className = 'rematch-container';
            div.innerHTML = `<button class="rematch-btn" onclick="startSearch()">ğŸ”„ æ‰¾ä¸‹ä¸€å€‹</button>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- Socket ç›£è½ ---

        socket.on('connect', () => {
            console.log('Connected as:', myUserId);
            statusBar.style.display = 'none';
            if (socket.autoStartSearch) {
                socket.autoStartSearch = false;
                startSearch();
            } else if (!currentRoom && !isSearching) {
                mainBtn.disabled = false;
                mainBtn.innerText = 'é–‹å§‹';
            }
        });

        socket.on('disconnect', () => {
            statusBar.style.display = 'block';
            mainBtn.disabled = true;
        });

        socket.on('matched', (data) => {
            isSearching = false;
            if (waitTimer) clearInterval(waitTimer);
            
            currentRoom = data.roomId;
            chatBox.innerHTML = '';
            addSystemMsg('ğŸ‰ é…å°æˆåŠŸï¼å¤§å®¶æ‰“å€‹æ‹›å‘¼å§');
            
            msgInput.disabled = false;
            msgInput.placeholder = "è¼¸å…¥è¨Šæ¯...";
            mainBtn.innerText = 'å‚³é€';
            mainBtn.disabled = false;
            endBtn.style.display = 'block';
        });

        socket.on('receive_msg', (data) => {
            typingBubble.style.display = 'none';
            addMsg(data.msg, 'partner');
        });

        socket.on('partner_left', (data) => {
            addSystemMsg(data.msg || 'å°æ–¹å·²é›¢é–‹');
            resetToIdle();
            showRematchButton();
        });

        socket.on('partner_typing', () => {
            typingBubble.style.display = 'flex';
            chatBox.appendChild(typingBubble);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('partner_stop_typing', () => {
            typingBubble.style.display = 'none';
        });

        // è¼”åŠ©å‡½å¼
        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg-wrapper ${type}`;
            div.innerHTML = `<div class="msg ${type}">${text}</div>`;
            chatBox.insertBefore(div, typingBubble);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system';
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function toggleSidebar(e) { e.stopPropagation(); document.getElementById('sidebar').classList.toggle('open'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

        // æ‰“å­—ç‹€æ…‹ç›£è½
        msgInput.addEventListener('input', () => {
            if (currentRoom) {
                socket.emit('typing');
                clearTimeout(window.tTimer);
                window.tTimer = setTimeout(() => socket.emit('stop_typing'), 2000);
            }
        });

        msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMsg(); });
    </script>
</body>
</html>